---
phase: 05-user-learning-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/Orbit.Application/UserFacts/Queries/GetUserFactsQuery.cs
  - src/Orbit.Application/UserFacts/Commands/DeleteUserFactCommand.cs
  - src/Orbit.Api/Controllers/UserFactsController.cs
  - tests/Orbit.IntegrationTests/UserFactsControllerTests.cs
  - tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "User can retrieve all stored facts about themselves via GET /api/user-facts"
    - "User can delete individual facts they no longer want AI to remember via DELETE /api/user-facts/{id}"
    - "Deleted facts no longer appear in GET response or AI system prompt"
    - "Integration tests verify fact extraction from chat and fact CRUD via API"
  artifacts:
    - path: "src/Orbit.Application/UserFacts/Queries/GetUserFactsQuery.cs"
      provides: "Query handler returning user's active facts"
      contains: "class GetUserFactsQueryHandler"
    - path: "src/Orbit.Application/UserFacts/Commands/DeleteUserFactCommand.cs"
      provides: "Command handler for soft-deleting a user fact"
      contains: "class DeleteUserFactCommandHandler"
    - path: "src/Orbit.Api/Controllers/UserFactsController.cs"
      provides: "REST API endpoints for user facts"
      contains: "class UserFactsController"
    - path: "tests/Orbit.IntegrationTests/UserFactsControllerTests.cs"
      provides: "Integration tests for user facts API"
      contains: "class UserFactsControllerTests"
  key_links:
    - from: "src/Orbit.Api/Controllers/UserFactsController.cs"
      to: "GetUserFactsQuery"
      via: "MediatR Send"
      pattern: "mediator.Send.*GetUserFactsQuery"
    - from: "src/Orbit.Api/Controllers/UserFactsController.cs"
      to: "DeleteUserFactCommand"
      via: "MediatR Send"
      pattern: "mediator.Send.*DeleteUserFactCommand"
    - from: "tests/Orbit.IntegrationTests/UserFactsControllerTests.cs"
      to: "/api/user-facts"
      via: "HttpClient GET and DELETE"
      pattern: "client\\.(GetAsync|DeleteAsync).*user-facts"
---

<objective>
Create REST API endpoints for viewing and deleting user facts, plus comprehensive integration tests for the entire user learning pipeline (fact extraction from chat + fact CRUD).

Purpose: Give users visibility and control over what the AI remembers about them (ULRN-03, ULRN-04). Verify the full learning pipeline works end-to-end.
Output: UserFactsController with GET/DELETE endpoints, CQRS handlers, integration tests.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-user-learning-system/05-RESEARCH.md
@.planning/phases/05-user-learning-system/05-01-SUMMARY.md

Key files to reference:
@src/Orbit.Api/Controllers/TagsController.cs — Controller pattern (Authorize, ApiController, MediatR, HttpContext.GetUserId())
@src/Orbit.Application/Tags/Queries/GetTagsQuery.cs — Query handler pattern
@src/Orbit.Application/Tags/Commands/DeleteTagCommand.cs — Delete command pattern
@tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs — Integration test pattern (WebApplicationFactory, auth, rate limiting)
@tests/Orbit.IntegrationTests/HabitsControllerTests.cs — Controller test pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserFacts CQRS handlers and API controller</name>
  <files>
    src/Orbit.Application/UserFacts/Queries/GetUserFactsQuery.cs
    src/Orbit.Application/UserFacts/Commands/DeleteUserFactCommand.cs
    src/Orbit.Api/Controllers/UserFactsController.cs
  </files>
  <action>
    **1. Create GetUserFactsQuery** (`src/Orbit.Application/UserFacts/Queries/GetUserFactsQuery.cs`):
    - `record GetUserFactsQuery(Guid UserId) : IRequest<IReadOnlyList<UserFactDto>>`
    - `record UserFactDto(Guid Id, string FactText, string? Category, DateTime ExtractedAtUtc, DateTime? UpdatedAtUtc)`
    - Handler: `GetUserFactsQueryHandler` with `IGenericRepository<UserFact>` injected
    - Query: `userFactRepository.FindAsync(f => f.UserId == request.UserId, cancellationToken)`
    - Map to DTOs ordered by ExtractedAtUtc descending (most recent first)
    - Global query filter automatically excludes soft-deleted facts
    - Follow exact pattern from GetTagsQuery (bare return type, no Result wrapper for queries)

    **2. Create DeleteUserFactCommand** (`src/Orbit.Application/UserFacts/Commands/DeleteUserFactCommand.cs`):
    - `record DeleteUserFactCommand(Guid UserId, Guid FactId) : IRequest<Result>`
    - Handler: `DeleteUserFactCommandHandler` with `IGenericRepository<UserFact>` injected via primary constructor, plus `IUnitOfWork`
    - Load fact using `FindOneTrackedAsync` (tracked because we need to modify it):
      ```csharp
      var fact = await userFactRepository.FindOneTrackedAsync(
          f => f.Id == request.FactId && f.UserId == request.UserId,
          cancellationToken: cancellationToken);
      ```
    - IMPORTANT: The global query filter on IsDeleted means FindOneTrackedAsync will NOT return already-deleted facts — no need for additional IsDeleted check
    - If null: return `Result.Failure("Fact not found.")`
    - Call `fact.SoftDelete()`
    - Call `await unitOfWork.SaveChangesAsync(cancellationToken)`
    - Return `Result.Success()`
    - Follow pattern from DeleteTagCommand

    **3. Create UserFactsController** (`src/Orbit.Api/Controllers/UserFactsController.cs`):
    - `[Authorize]`, `[ApiController]`, `[Route("api/user-facts")]`
    - Primary constructor with `IMediator mediator`
    - **GET /api/user-facts**: Returns `Ok(result)` with list of UserFactDto
    - **DELETE /api/user-facts/{id:guid}**: Returns `NoContent()` on success, `NotFound(new { error = result.Error })` on failure
    - Use `HttpContext.GetUserId()` extension method for user ID (from `Orbit.Api.Extensions`)
    - Follow exact pattern from TagsController (Authorize, extension method, result handling)
  </action>
  <verify>
    Run `dotnet build` from solution root — all projects must compile.
    Verify controller has [Authorize] attribute.
    Verify GetUserFactsQuery returns ordered DTOs.
    Verify DeleteUserFactCommand uses soft delete (fact.SoftDelete()), not repository.Remove().
  </verify>
  <done>
    GET /api/user-facts endpoint returns user's active facts as DTOs ordered by recency (ULRN-03).
    DELETE /api/user-facts/{id} soft-deletes a fact with ownership check (ULRN-04).
    Soft-deleted facts excluded by global query filter from all queries.
    All projects compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for user facts pipeline</name>
  <files>
    tests/Orbit.IntegrationTests/UserFactsControllerTests.cs
    tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
  </files>
  <action>
    **1. Create UserFactsControllerTests** (`tests/Orbit.IntegrationTests/UserFactsControllerTests.cs`):
    - Follow exact pattern from HabitsControllerTests: `[Collection("Sequential")]`, `IAsyncLifetime`, `WebApplicationFactory<Program>`
    - Setup: Register test user, login, get auth token, set Authorization header
    - Teardown: Clean up created facts via DELETE endpoint, wrapped in try-catch

    **Test cases (4-5 tests):**

    a) `GetUserFacts_WhenNoFacts_ReturnsEmptyArray`:
    - GET /api/user-facts
    - Assert: 200 OK, empty array

    b) `GetUserFacts_AfterChat_ReturnsFacts`:
    - Send chat message with personal info: "I'm a morning person and I work as a software developer, create a daily coding habit"
    - Wait a moment for fact extraction to complete (it's synchronous but after main response)
    - GET /api/user-facts
    - Assert: 200 OK, response contains facts (at least 1)
    - Assert: Facts have factText, category fields populated
    - NOTE: This test depends on Gemini extracting facts correctly — use a message rich in personal context

    c) `DeleteUserFact_ExistingFact_ReturnsNoContent`:
    - First trigger fact creation via chat (same as above)
    - GET /api/user-facts to find a fact ID
    - DELETE /api/user-facts/{factId}
    - Assert: 204 NoContent
    - GET /api/user-facts again
    - Assert: Deleted fact no longer in list

    d) `DeleteUserFact_NonExistentId_ReturnsNotFound`:
    - DELETE /api/user-facts/{random-guid}
    - Assert: 404 NotFound (or 400 BadRequest depending on handler implementation — use NotFound)

    e) `GetUserFacts_Unauthorized_Returns401`:
    - Make GET /api/user-facts request WITHOUT Authorization header
    - Assert: 401 Unauthorized

    **Rate limiting**: Use the same SemaphoreSlim + 10s delay pattern from AiChatIntegrationTests for any calls that hit the Gemini API (chat messages). Direct API calls to /api/user-facts don't need rate limiting.

    **Helper method**: Create `SendChatMessage(string message)` helper similar to AiChatIntegrationTests pattern — POST to /api/chat, handle rate limiting, return response.

    **DTO classes**: Define inline:
    ```csharp
    private record UserFactDto(Guid Id, string FactText, string? Category, DateTime ExtractedAtUtc, DateTime? UpdatedAtUtc);
    private record ChatResponse(string? AiMessage, object[]? Actions);
    ```

    **2. Update AiChatIntegrationTests** if needed:
    - The existing tests should still pass since fact extraction is non-blocking and happens after the response is returned
    - If any tests fail due to the changed `IAiIntentService.InterpretAsync` signature or `SystemPromptBuilder.BuildSystemPrompt` signature, the compilation errors would have been caught in Plan 05-01
    - No changes expected here, but verify compilation
  </action>
  <verify>
    Run `dotnet build tests/Orbit.IntegrationTests` — must compile.
    Run `dotnet test tests/Orbit.IntegrationTests --filter "FullyQualifiedName~UserFactsControllerTests"` — tests must pass.
    Verify at least 4 test methods exist in UserFactsControllerTests.
    Verify rate limiting is applied to chat-dependent tests.
  </verify>
  <done>
    Integration tests verify: empty facts list, fact creation via chat, fact deletion, 404 on missing fact, 401 unauthorized.
    All tests pass against live Gemini API.
    Existing AiChatIntegrationTests still compile and pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes for all projects
2. `dotnet test tests/Orbit.IntegrationTests --filter "UserFactsControllerTests"` — all tests pass
3. GET /api/user-facts returns facts with id, factText, category, timestamps
4. DELETE /api/user-facts/{id} soft-deletes and excluded from subsequent GET
5. Unauthorized requests to /api/user-facts return 401
6. Existing AI chat tests still pass
</verification>

<success_criteria>
- GET /api/user-facts returns user's facts ordered by recency (ULRN-03)
- DELETE /api/user-facts/{id} soft-deletes individual facts (ULRN-04)
- Integration tests prove the full pipeline: chat -> fact extraction -> persistence -> retrieval -> deletion
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-user-learning-system/05-02-SUMMARY.md`
</output>
