---
phase: 04-multi-action-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Orbit.Application/Habits/Commands/BulkCreateHabitsCommand.cs
  - src/Orbit.Application/Habits/Commands/BulkDeleteHabitsCommand.cs
  - src/Orbit.Application/Habits/Validators/BulkCreateHabitsCommandValidator.cs
  - src/Orbit.Application/Habits/Validators/BulkDeleteHabitsCommandValidator.cs
  - src/Orbit.Api/Controllers/HabitsController.cs
  - tests/Orbit.IntegrationTests/HabitsControllerTests.cs
autonomous: true

must_haves:
  truths:
    - "User can create multiple habits with parent-child relationships in a single bulk request"
    - "User can delete multiple habits at once via bulk delete endpoint"
    - "When one habit in a bulk create fails validation, other habits still succeed"
    - "When one habit in a bulk delete fails, other deletions still succeed"
    - "Bulk create response includes per-item status with habit IDs for successes and errors for failures"
  artifacts:
    - path: "src/Orbit.Application/Habits/Commands/BulkCreateHabitsCommand.cs"
      provides: "Bulk habit creation with parent-child support and partial success"
      contains: "BulkCreateHabitsCommand"
    - path: "src/Orbit.Application/Habits/Commands/BulkDeleteHabitsCommand.cs"
      provides: "Bulk habit deletion with partial success"
      contains: "BulkDeleteHabitsCommand"
    - path: "src/Orbit.Application/Habits/Validators/BulkCreateHabitsCommandValidator.cs"
      provides: "Validation for bulk create request items"
      contains: "BulkCreateHabitsCommandValidator"
    - path: "src/Orbit.Api/Controllers/HabitsController.cs"
      provides: "POST /api/habits/bulk and DELETE /api/habits/bulk endpoints"
      contains: "BulkCreate"
  key_links:
    - from: "HabitsController.BulkCreate"
      to: "BulkCreateHabitsCommand"
      via: "MediatR Send"
      pattern: "new BulkCreateHabitsCommand"
    - from: "HabitsController.BulkDelete"
      to: "BulkDeleteHabitsCommand"
      via: "MediatR Send"
      pattern: "new BulkDeleteHabitsCommand"
    - from: "BulkCreateHabitsCommandHandler"
      to: "Habit.Create"
      via: "domain entity factory for each item"
      pattern: "Habit\\.Create"
    - from: "BulkCreateHabitsCommandHandler"
      to: "habitRepository.AddAsync"
      via: "explicit AddAsync per entity (EF Guid.NewGuid gotcha)"
      pattern: "AddAsync"
---

<objective>
Create general-purpose bulk endpoints for habits: `POST /api/habits/bulk` for batch creation with parent-child relationships and `DELETE /api/habits/bulk` for batch deletion. Both follow the "keep successes" partial failure policy consistent with the chat pipeline.

Purpose: Enables frontend multi-select operations and serves as the confirmation endpoint for AI-suggested habit breakdowns. A user who receives a SuggestBreakdown response from chat can edit the suggestions and submit them through the bulk create endpoint.

Output: Two new API endpoints with commands, validators, handlers, and integration tests.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-action-foundation/04-CONTEXT.md
@.planning/phases/04-multi-action-foundation/04-RESEARCH.md
@src/Orbit.Domain/Entities/Habit.cs
@src/Orbit.Domain/Interfaces/IGenericRepository.cs
@src/Orbit.Domain/Interfaces/IUnitOfWork.cs
@src/Orbit.Application/Habits/Commands/CreateHabitCommand.cs
@src/Orbit.Application/Habits/Commands/DeleteHabitCommand.cs
@src/Orbit.Application/Habits/Validators/CreateHabitCommandValidator.cs
@src/Orbit.Api/Controllers/HabitsController.cs
@tests/Orbit.IntegrationTests/HabitsControllerTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BulkCreateHabits command with parent-child support and partial success</name>
  <files>
    src/Orbit.Application/Habits/Commands/BulkCreateHabitsCommand.cs
    src/Orbit.Application/Habits/Validators/BulkCreateHabitsCommandValidator.cs
  </files>
  <action>
1. Create `BulkCreateHabitsCommand.cs` with:

```csharp
public record BulkCreateHabitsCommand(
    Guid UserId,
    IReadOnlyList<BulkHabitItem> Habits) : IRequest<Result<BulkCreateResult>>;

public record BulkHabitItem(
    string Title,
    string? Description,
    FrequencyUnit? FrequencyUnit,
    int? FrequencyQuantity,
    IReadOnlyList<DayOfWeek>? Days = null,
    bool IsBadHabit = false,
    DateOnly? DueDate = null,
    IReadOnlyList<BulkHabitItem>? SubHabits = null);

public record BulkCreateResult(IReadOnlyList<BulkCreateItemResult> Results);

public record BulkCreateItemResult(
    int Index,
    BulkItemStatus Status,
    Guid? HabitId = null,
    string? Title = null,
    string? Error = null,
    string? Field = null);

public enum BulkItemStatus { Success, Failed }
```

2. Implement `BulkCreateHabitsCommandHandler`:
   - Iterate over `command.Habits` with index tracking.
   - For each item, call `Habit.Create(userId, item.Title, ...)` with all fields.
   - If the parent habit creates successfully AND the item has SubHabits, iterate over SubHabits and create child Habits with `parentHabitId: parentHabit.Id`.
   - Use `habitRepository.AddAsync()` explicitly for EVERY entity (parent and children) -- this is critical due to the EF Core Guid.NewGuid() gotcha where EF treats non-default GUIDs as existing (Modified) rather than Added.
   - Wrap each top-level item (and its children) in a try-catch. On failure, add a `BulkCreateItemResult` with Status=Failed, Error=the error message, and Field if derivable from a validation error.
   - On success, add a `BulkCreateItemResult` with Status=Success, HabitId=parentHabit.Id, Title=parentHabit.Title.
   - After processing all items, call `unitOfWork.SaveChangesAsync()` once to commit all successful entities.
   - Return `BulkCreateResult` with all results.
   - Cap at 100 items max (validated in validator).

3. Create `BulkCreateHabitsCommandValidator.cs`:
   - `Habits` must not be empty and must have at most 100 items.
   - `RuleForEach(x => x.Habits)` with child validator for `BulkHabitItem`:
     - Title: NotEmpty, MaximumLength(200)
     - FrequencyQuantity: GreaterThan(0) when not null
     - Days: Must be null/empty or FrequencyQuantity == 1
     - SubHabits: at most 20, each with NotEmpty title and MaximumLength(200)
   - Use `SetValidator` with a separate `BulkHabitItemValidator` class for the child rules.

IMPORTANT: Follow the exact same patterns as `CreateHabitCommand.cs` and `CreateHabitCommandValidator.cs`. Same repository injection via primary constructor, same `Result<T>` return pattern, same domain validation via `Habit.Create()`.

IMPORTANT: Do NOT use a transaction scope. The "keep successes" policy means successful items persist even when others fail. The single `SaveChangesAsync` at the end naturally commits everything that was added.
  </action>
  <verify>
Run `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` -- must compile with zero errors.
  </verify>
  <done>
BulkCreateHabitsCommand accepts an array of habit definitions with optional nested SubHabits. Handler creates parent and child Habit entities via domain factory, handles per-item errors, returns per-item results. Validator enforces 100-item cap, title length, frequency rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BulkDeleteHabits command and add both bulk endpoints to controller</name>
  <files>
    src/Orbit.Application/Habits/Commands/BulkDeleteHabitsCommand.cs
    src/Orbit.Application/Habits/Validators/BulkDeleteHabitsCommandValidator.cs
    src/Orbit.Api/Controllers/HabitsController.cs
  </files>
  <action>
1. Create `BulkDeleteHabitsCommand.cs`:

```csharp
public record BulkDeleteHabitsCommand(
    Guid UserId,
    IReadOnlyList<Guid> HabitIds) : IRequest<Result<BulkDeleteResult>>;

public record BulkDeleteResult(IReadOnlyList<BulkDeleteItemResult> Results);

public record BulkDeleteItemResult(
    int Index,
    BulkItemStatus Status,
    Guid HabitId,
    string? Error = null);
```

Reuse `BulkItemStatus` from BulkCreateHabitsCommand (or move it to a shared location -- put it in the same namespace, either file is fine since both are in `Orbit.Application.Habits.Commands`). If the compiler complains about duplicate enum, define it in only one file and reference from the other.

2. Implement `BulkDeleteHabitsCommandHandler`:
   - Iterate over `command.HabitIds` with index.
   - For each ID: `GetByIdAsync`, check exists, check `UserId` matches, then `habitRepository.Remove(habit)`.
   - On failure (not found, wrong user): add `BulkDeleteItemResult` with Status=Failed and error.
   - On success: add `BulkDeleteItemResult` with Status=Success.
   - Wrap each deletion in try-catch for unexpected errors.
   - Call `unitOfWork.SaveChangesAsync()` once at the end.
   - Cap at 100 IDs max.

3. Create `BulkDeleteHabitsCommandValidator.cs`:
   - `HabitIds` must not be empty, at most 100 items.
   - Each ID must not be empty (Guid.Empty).

4. Update `HabitsController.cs` -- add two new endpoints:

   a. `POST /api/habits/bulk`:
   ```csharp
   public record BulkCreateHabitsRequest(IReadOnlyList<BulkHabitItemRequest> Habits);

   public record BulkHabitItemRequest(
       string Title,
       string? Description,
       FrequencyUnit? FrequencyUnit,
       int? FrequencyQuantity,
       IReadOnlyList<DayOfWeek>? Days = null,
       bool IsBadHabit = false,
       DateOnly? DueDate = null,
       IReadOnlyList<BulkHabitItemRequest>? SubHabits = null);
   ```
   Map `BulkHabitItemRequest` to `BulkHabitItem` recursively (for nested sub-habits). Return 200 OK with the `BulkCreateResult` (not 201, since it's a batch with possible partial failure).

   b. `DELETE /api/habits/bulk`:
   ```csharp
   public record BulkDeleteHabitsRequest(IReadOnlyList<Guid> HabitIds);
   ```
   Accept as `[FromBody]` (DELETE with body is acceptable for bulk operations). Return 200 OK with `BulkDeleteResult`.

   Place request records as nested types in the controller (same pattern as existing `CreateHabitRequest`, `LogHabitRequest`).

IMPORTANT: Use `[HttpPost("bulk")]` and `[HttpDelete("bulk")]` route attributes to create `/api/habits/bulk` paths. These are separate from the existing POST/DELETE habit endpoints.

IMPORTANT: The mapping from `BulkHabitItemRequest` to `BulkHabitItem` must be recursive for SubHabits. Write a private helper method like `MapToBulkHabitItem(BulkHabitItemRequest req)` that handles the recursion.
  </action>
  <verify>
Run `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` -- must compile with zero errors.
  </verify>
  <done>
BulkDeleteHabitsCommand handles batch deletion with per-item error reporting. HabitsController has `POST /api/habits/bulk` and `DELETE /api/habits/bulk` endpoints. Both return 200 with per-item results array showing success/failure status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for bulk endpoints</name>
  <files>
    tests/Orbit.IntegrationTests/HabitsControllerTests.cs
  </files>
  <action>
Add new integration tests to `HabitsControllerTests.cs` for the bulk endpoints. Follow the existing test patterns (auth helper, HTTP client, JSON assertions).

1. **Test: Bulk create with parent-child** -- POST to `/api/habits/bulk` with 2 habits, one of which has 2 sub-habits. Assert response has 2 results with Status="Success" and valid HabitIds. Verify via GET /api/habits that the parent has children.

2. **Test: Bulk create partial failure** -- POST to `/api/habits/bulk` with 3 habits where one has an empty title. Assert 2 results with Status="Success" and 1 with Status="Failed" and an error message. Verify via GET /api/habits that the 2 valid habits exist.

3. **Test: Bulk delete** -- Create 3 habits first, then DELETE to `/api/habits/bulk` with their IDs. Assert all 3 results have Status="Success". Verify via GET /api/habits that they're gone.

4. **Test: Bulk delete partial failure** -- Create 2 habits, then DELETE with 3 IDs (2 valid + 1 random GUID). Assert 2 succeed and 1 fails with "not found" error.

5. **Test: Bulk create empty array** -- POST with empty habits array. Assert 400 Bad Request (validation failure).

6. **Test: Bulk delete empty array** -- DELETE with empty habitIds array. Assert 400 Bad Request (validation failure).

Use `JsonSerializerOptions` with `PropertyNameCaseInsensitive = true` and `JsonStringEnumConverter()` for deserialization, consistent with existing tests.

For the DELETE with body, use `HttpRequestMessage` with Method=DELETE and Content set to the JSON body, since `HttpClient.DeleteAsync` doesn't accept a body.
  </action>
  <verify>
Run `dotnet test C:/Users/thoma/Documents/Programming/Projects/Orbit/tests/Orbit.IntegrationTests/ --filter "ClassName~HabitsController"` -- all tests pass (both existing and new).
  </verify>
  <done>
6 new integration tests cover bulk create (success, partial failure, parent-child), bulk delete (success, partial failure), and validation (empty arrays). All tests pass against the running API.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` compiles with zero errors
2. `dotnet test C:/Users/thoma/Documents/Programming/Projects/Orbit/tests/Orbit.IntegrationTests/ --filter "ClassName~HabitsController"` -- all habit tests pass
3. POST /api/habits/bulk with `{ habits: [{ title: "A" }, { title: "B", subHabits: [{ title: "B1" }] }] }` returns 200 with per-item results
4. DELETE /api/habits/bulk with `{ habitIds: ["id1", "id2"] }` returns 200 with per-item results
5. Partial failure: one invalid item in bulk create does not prevent valid items from being created
</verification>

<success_criteria>
- POST /api/habits/bulk creates multiple habits with parent-child relationships in one request (MACT-03 confirmation path)
- DELETE /api/habits/bulk deletes multiple habits in one request (user decision: frontend multi-select)
- Both endpoints follow keep-successes partial failure policy (MACT-02)
- Both return per-item status with IDs for successes and field-level errors for failures (MACT-05)
- Validation enforces 100-item cap, title requirements, frequency rules
- 6 new integration tests all pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-action-foundation/04-02-SUMMARY.md`
</output>
