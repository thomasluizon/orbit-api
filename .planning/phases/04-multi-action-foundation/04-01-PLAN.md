---
phase: 04-multi-action-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Orbit.Domain/Enums/AiActionType.cs
  - src/Orbit.Domain/Models/AiAction.cs
  - src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
  - src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
autonomous: true

must_haves:
  truths:
    - "User can request multiple habit creations in one prompt and all are created"
    - "User can log multiple habits at once and both logs are recorded"
    - "When one action in a batch fails, other actions still succeed"
    - "Chat response shows success/failure for each action with clear error messages"
    - "AI can return a suggest_breakdown action with proposed parent and sub-habits"
  artifacts:
    - path: "src/Orbit.Domain/Enums/AiActionType.cs"
      provides: "SuggestBreakdown enum value"
      contains: "SuggestBreakdown"
    - path: "src/Orbit.Domain/Models/AiAction.cs"
      provides: "SuggestedSubHabits field for breakdown suggestions"
      contains: "SuggestedSubHabits"
    - path: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      provides: "Per-action error handling and structured ActionResult response"
      contains: "ActionResult"
    - path: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      provides: "Multi-action examples and SuggestBreakdown documentation in AI prompt"
      contains: "SuggestBreakdown"
  key_links:
    - from: "ProcessUserChatCommandHandler"
      to: "AiActionType.SuggestBreakdown"
      via: "switch expression case"
      pattern: "AiActionType\\.SuggestBreakdown"
    - from: "ProcessUserChatCommandHandler"
      to: "ActionResult"
      via: "per-action try-catch aggregation"
      pattern: "new ActionResult"
    - from: "SystemPromptBuilder"
      to: "AiAction.SuggestedSubHabits"
      via: "JSON schema documentation in prompt"
      pattern: "suggestedSubHabits"
---

<objective>
Refactor the AI chat pipeline to support multiple actions per prompt with per-action error handling and structured status responses. Add SuggestBreakdown action type for habit decomposition suggestions.

Purpose: Enables the AI to process complex user requests like "create habits for exercise, meditation, and reading" or "I exercised and meditated today" in a single prompt, returning per-action results with success/failure status. Also adds the ability for AI to suggest habit breakdowns without creating anything.

Output: Upgraded chat endpoint returning `{ aiMessage, actions: [{ type, status, entityId?, entityName?, error?, field? }] }` with multi-action support and partial failure handling.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-multi-action-foundation/04-CONTEXT.md
@.planning/phases/04-multi-action-foundation/04-RESEARCH.md
@src/Orbit.Domain/Enums/AiActionType.cs
@src/Orbit.Domain/Models/AiAction.cs
@src/Orbit.Domain/Models/AiActionPlan.cs
@src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
@src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
@src/Orbit.Infrastructure/Services/GeminiIntentService.cs
@src/Orbit.Infrastructure/Services/AiIntentService.cs
@src/Orbit.Api/Controllers/ChatController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand domain models and restructure ChatResponse for per-action results</name>
  <files>
    src/Orbit.Domain/Enums/AiActionType.cs
    src/Orbit.Domain/Models/AiAction.cs
    src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
  </files>
  <action>
1. In `AiActionType.cs`: Add `SuggestBreakdown` to the enum (after `AssignTag`). This is a distinct action type per user decision -- it carries proposed parent + sub-habits but creates nothing.

2. In `AiAction.cs`: Add a new property for breakdown suggestions:
   - `List<AiAction>? SuggestedSubHabits { get; init; }` -- each sub-action carries Title, Description, FrequencyUnit, FrequencyQuantity, Days, DueDate for the suggested sub-habit. This reuses AiAction as the shape for suggested children.
   - The existing `SubHabits` (List<string>) is for inline sub-habit creation during CreateHabit. `SuggestedSubHabits` is for SuggestBreakdown responses where the AI proposes structured sub-habits that require user confirmation.

3. In `ProcessUserChatCommand.cs`:

   a. Replace the existing `ChatResponse` record with a structured version:
   ```csharp
   public record ChatResponse(string? AiMessage, IReadOnlyList<ActionResult> Actions);

   public record ActionResult(
       AiActionType Type,
       ActionStatus Status,
       Guid? EntityId = null,
       string? EntityName = null,
       string? Error = null,
       string? Field = null,
       IReadOnlyList<AiAction>? SuggestedSubHabits = null);

   public enum ActionStatus { Success, Failed, Suggestion }
   ```
   Place `ActionStatus` enum in the same file since it is only used by `ChatResponse`.
   `SuggestedSubHabits` on `ActionResult` is populated only for SuggestBreakdown actions -- carries the AI's proposed sub-habits so the frontend can render them for user editing/confirmation.

   b. Refactor the handler's foreach loop to wrap each action execution in try-catch and collect `ActionResult` items:
   ```csharp
   var actionResults = new List<ActionResult>();

   foreach (var action in plan.Actions)
   {
       try
       {
           var actionResult = action.Type switch
           {
               AiActionType.LogHabit => await ExecuteLogHabitAsync(action, request.UserId, cancellationToken),
               AiActionType.CreateHabit => await ExecuteCreateHabitAsync(action, request.UserId, cancellationToken),
               AiActionType.AssignTag => await ExecuteAssignTagAsync(action, request.UserId, cancellationToken),
               AiActionType.SuggestBreakdown => ExecuteSuggestBreakdown(action),
               _ => Result.Failure<(Guid? Id, string? Name)>($"Unknown action type: {action.Type}")
           };

           if (actionResult.IsSuccess)
           {
               var (id, name) = actionResult.Value;
               actionResults.Add(new ActionResult(action.Type, ActionStatus.Success, id, name));
           }
           else
           {
               actionResults.Add(new ActionResult(action.Type, ActionStatus.Failed, EntityName: action.Title, Error: actionResult.Error));
           }
       }
       catch (Exception ex)
       {
           logger.LogError(ex, "Unexpected error executing action {Type}", action.Type);
           actionResults.Add(new ActionResult(action.Type, ActionStatus.Failed, EntityName: action.Title, Error: "An unexpected error occurred."));
       }
   }
   ```

   c. Change the return type of `ExecuteLogHabitAsync`, `ExecuteCreateHabitAsync`, and `ExecuteAssignTagAsync` from `Result` to `Result<(Guid? Id, string? Name)>` so they can return the entity ID and name for the ActionResult:
   - `ExecuteCreateHabitAsync`: return `(habit.Id, habit.Title)` on success
   - `ExecuteLogHabitAsync`: return `(habit.Id, habit.Title)` on success
   - `ExecuteAssignTagAsync`: return `(action.HabitId, action.Title)` on success (or the habit title)

   d. Add `ExecuteSuggestBreakdown` method:
   ```csharp
   private static Result<(Guid? Id, string? Name)> ExecuteSuggestBreakdown(AiAction action)
   {
       // SuggestBreakdown creates nothing -- it just passes through the AI's suggestions
       // The ActionResult will carry the suggestions for frontend rendering
       return Result.Success<(Guid? Id, string? Name)>((null, action.Title));
   }
   ```
   Then in the success branch for SuggestBreakdown, set the ActionResult differently:
   ```csharp
   if (action.Type == AiActionType.SuggestBreakdown)
   {
       actionResults.Add(new ActionResult(
           action.Type,
           ActionStatus.Suggestion,
           EntityName: action.Title,
           SuggestedSubHabits: action.SuggestedSubHabits));
   }
   ```

   e. Update the final return: `return Result.Success(new ChatResponse(plan.AiMessage, actionResults));`

   f. Keep the existing `SaveChangesAsync` call at the end (after all actions) -- this commits all successful creates/logs in one batch per the "keep successes" policy.

IMPORTANT: Do NOT change `AiActionPlan.cs` -- it already has `IReadOnlyList<AiAction> Actions` which supports multiple items. The model is already correct; the change is in prompting (Task 2) and handling (this task).

IMPORTANT: Preserve all existing stopwatch logging -- just extend it for the new flow.
  </action>
  <verify>
Run `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` -- must compile with zero errors. The refactored ChatResponse is a breaking change to the response shape but that is intentional per user decision.
  </verify>
  <done>
AiActionType has SuggestBreakdown. AiAction has SuggestedSubHabits. ChatResponse returns `{ aiMessage, actions[] }` with per-action ActionResult containing type, status, entityId, entityName, error, field. Handler wraps each action in try-catch for partial failure. SuggestBreakdown actions return suggestions without creating DB entities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SystemPromptBuilder for multi-action and SuggestBreakdown prompting</name>
  <files>
    src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
  </files>
  <action>
Update `SystemPromptBuilder.BuildSystemPrompt` to teach the AI about multi-action responses and the SuggestBreakdown action type. Changes to the prompt:

1. **Update Core Rules section** -- strengthen rule 6 ("A single message may contain MULTIPLE actions") with explicit guidance:
   - "When user mentions multiple activities or requests, return ALL of them as separate actions in the actions array."
   - "You can mix action types freely -- e.g., CreateHabit + LogHabit + AssignTag all in one response."
   - "Each action is independent -- include all relevant fields on each action."

2. **Add SuggestBreakdown documentation** to the "What You CAN Do" section:
   - "Break down complex goals into parent + sub-habit suggestions (e.g., 'help me get fit' -> suggests Exercise parent with Running, Stretching, Gym sub-habits)"
   - "Suggest habit breakdowns when user asks to decompose or break down a goal"

3. **Add SuggestBreakdown to Action Types section:**
   ```
   SuggestBreakdown: type, title (parent habit name), description (optional), frequencyUnit, frequencyQuantity, dueDate, suggestedSubHabits (array of habit objects with title, description, frequencyUnit, frequencyQuantity, dueDate)
   ```

4. **Add multi-action examples** to the examples section:

   Example: Multiple creates
   ```
   User: "I want to start exercising, meditating, and reading every day"
   {
     "actions": [
       { "type": "CreateHabit", "title": "Exercise", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" },
       { "type": "CreateHabit", "title": "Meditation", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" },
       { "type": "CreateHabit", "title": "Reading", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" }
     ],
     "aiMessage": "Created 3 new daily habits: Exercise, Meditation, and Reading!"
   }
   ```

   Example: Multiple logs
   ```
   User: "I exercised and meditated today" (both habits exist with IDs)
   {
     "actions": [
       { "type": "LogHabit", "habitId": "abc-123" },
       { "type": "LogHabit", "habitId": "def-456" }
     ],
     "aiMessage": "Logged your exercise and meditation!"
   }
   ```

   Example: Mixed actions
   ```
   User: "I ran today and I want to start a yoga habit" (Running exists with ID, Yoga is new)
   {
     "actions": [
       { "type": "LogHabit", "habitId": "abc-123" },
       { "type": "CreateHabit", "title": "Yoga", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" }
     ],
     "aiMessage": "Logged your run and created a new daily yoga habit!"
   }
   ```

   Example: SuggestBreakdown
   ```
   User: "Help me break down getting fit into smaller habits"
   {
     "actions": [
       {
         "type": "SuggestBreakdown",
         "title": "Get Fit",
         "frequencyUnit": "Day",
         "frequencyQuantity": 1,
         "dueDate": "2026-02-09",
         "suggestedSubHabits": [
           { "type": "CreateHabit", "title": "Morning Run", "description": "30-minute jog", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" },
           { "type": "CreateHabit", "title": "Stretching", "description": "15-minute stretch routine", "frequencyUnit": "Day", "frequencyQuantity": 1, "dueDate": "2026-02-09" },
           { "type": "CreateHabit", "title": "Gym Session", "description": "Weight training", "frequencyUnit": "Week", "frequencyQuantity": 3, "dueDate": "2026-02-09" }
         ]
       }
     ],
     "aiMessage": "Here's a suggested breakdown for getting fit! Review the sub-habits and confirm which ones you'd like to create."
   }
   ```

5. **Add guidance for when to use SuggestBreakdown vs CreateHabit with SubHabits:**
   - "Use SuggestBreakdown when user asks to 'break down', 'decompose', 'help me plan', or asks for suggestions for a complex goal"
   - "Use CreateHabit with subHabits when user explicitly tells you what the sub-habits should be (e.g., 'create morning routine with meditate, journal, stretch')"
   - "SuggestBreakdown NEVER creates anything -- it only proposes. The user must confirm before creation."

6. **Keep all existing examples intact** -- only ADD new ones. Do not remove or modify existing single-action examples.

IMPORTANT: The prompt is already long. Be efficient with the additions -- use the same concise style as existing examples. Do not add excessive prose.
  </action>
  <verify>
Run `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` -- must compile. Visually inspect the prompt output by searching for "SuggestBreakdown" and "multiple" in the file to confirm multi-action guidance is present.
  </verify>
  <done>
SystemPromptBuilder includes multi-action examples (multiple creates, multiple logs, mixed actions), SuggestBreakdown action type documentation with example, and guidance for when to use SuggestBreakdown vs CreateHabit with subHabits. All existing single-action examples preserved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update integration tests for multi-action chat responses</name>
  <files>
    tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
  </files>
  <action>
Update existing AI chat integration tests to work with the new `ChatResponse` shape (`{ aiMessage, actions[] }` with `ActionResult` objects instead of the old `{ executedActions: string[], aiMessage }` shape).

1. **Fix existing test assertions** that check `executedActions` (the old string list) to instead check the new `actions` array with `type`, `status`, `entityId`, `entityName` fields. For example, tests that assert `executedActions` contains a string like "CreateHabit: Running" should instead assert `actions[0].type == "CreateHabit"` and `actions[0].status == "Success"`.

2. **Add new test: Multi-action create** -- Send a message like "I want to exercise daily, meditate daily, and read weekly" and verify the response contains 3 actions all with status "Success" and valid entityIds.

3. **Add new test: Partial failure** -- Create a habit first, then send a message that tries to log it AND create a habit with an empty title (which should fail validation). Verify one action succeeds and one fails with an error message.

4. Follow the existing test patterns in the file (auth helper, HTTP client setup, JSON deserialization). Use the same `JsonSerializerOptions` with `PropertyNameCaseInsensitive = true` and `JsonStringEnumConverter()`.

NOTE: The AI chat tests hit the real Gemini API. The multi-action prompt examples in the system prompt should guide Gemini to return multiple actions. Test messages should be unambiguous to get reliable multi-action responses.

NOTE: Be conservative with new tests -- the AI is non-deterministic. Focus on verifying the response SHAPE (actions array with correct fields) rather than exact action content. The partial failure test should use a deterministic failure (like logging a non-existent habit ID) rather than relying on AI behavior.
  </action>
  <verify>
Run `dotnet test C:/Users/thoma/Documents/Programming/Projects/Orbit/tests/Orbit.IntegrationTests/ --filter "ClassName~AiChat"` -- all tests pass (both updated existing and new ones). If Gemini API is unavailable, verify at minimum that `dotnet build` succeeds for the test project.
  </verify>
  <done>
Existing AI chat tests updated for new ChatResponse shape. New tests for multi-action creation and partial failure added. All tests compile and pass against the live API.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build C:/Users/thoma/Documents/Programming/Projects/Orbit/Orbit.slnx` compiles with zero errors
2. `dotnet test C:/Users/thoma/Documents/Programming/Projects/Orbit/tests/Orbit.IntegrationTests/ --filter "ClassName~AiChat"` -- all AI chat tests pass
3. POST /api/chat with a multi-action prompt returns `{ aiMessage, actions: [{ type, status, entityId, ... }] }` shape
4. SuggestBreakdown actions return status "Suggestion" with suggestedSubHabits populated
5. When one action fails, other actions in the same request still succeed (partial failure)
</verification>

<success_criteria>
- Chat endpoint returns structured `{ aiMessage, actions[] }` with per-action ActionResult (MACT-05)
- AI returns multiple create/log actions from a single prompt (MACT-01, MACT-04)
- Failed actions do not prevent successful actions from committing (MACT-02)
- SuggestBreakdown action type exists and carries proposed sub-habits without creating entities (MACT-03 partial -- confirmation via bulk endpoint is in Plan 02)
- All existing and new integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-action-foundation/04-01-SUMMARY.md`
</output>
