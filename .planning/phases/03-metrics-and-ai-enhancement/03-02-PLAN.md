---
phase: 03-metrics-and-ai-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Orbit.Domain/Enums/AiActionType.cs
  - src/Orbit.Domain/Models/AiAction.cs
  - src/Orbit.Domain/Interfaces/IAiIntentService.cs
  - src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
  - src/Orbit.Infrastructure/Services/GeminiIntentService.cs
  - src/Orbit.Infrastructure/Services/AiIntentService.cs
  - src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
autonomous: true

must_haves:
  truths:
    - "AI gracefully refuses out-of-scope requests with helpful messages instead of attempting invalid actions"
    - "AI can create sub-habits when creating habits via chat (e.g., 'create morning routine with meditate, journal, stretch')"
    - "AI suggests tags when creating habits via chat and can assign existing tags"
  artifacts:
    - path: "src/Orbit.Domain/Enums/AiActionType.cs"
      provides: "Expanded enum with CreateSubHabit and AssignTag"
      contains: "CreateSubHabit"
    - path: "src/Orbit.Domain/Models/AiAction.cs"
      provides: "Extended record with SubHabits and TagNames fields"
      contains: "SubHabits"
    - path: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      provides: "Updated prompt with sub-habit examples, tag awareness, and refined refusal patterns"
      contains: "CreateSubHabit"
    - path: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      provides: "Handler cases for CreateSubHabit and AssignTag action types"
      contains: "ExecuteCreateSubHabitAsync"
  key_links:
    - from: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      to: "src/Orbit.Domain/Enums/AiActionType.cs"
      via: "switch expression matching new action types"
      pattern: "AiActionType\\.CreateSubHabit"
    - from: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      to: "src/Orbit.Domain/Entities/Tag.cs"
      via: "accepts tags parameter to list user's existing tags"
      pattern: "IReadOnlyList<Tag>"
    - from: "src/Orbit.Infrastructure/Services/GeminiIntentService.cs"
      to: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      via: "passes tags to BuildSystemPrompt"
      pattern: "BuildSystemPrompt.*tags"
---

<objective>
Expand AI capabilities: graceful out-of-scope refusal, sub-habit creation via chat, and tag suggestion/assignment.

Purpose: Satisfies AI-01 (graceful refusal), AI-02 (sub-habits via chat), AI-03 (tag suggestion/assignment) -- the AI becomes more capable while staying within its boundaries.
Output: Extended AiActionType enum, updated system prompt with sub-habit/tag examples, handler cases for new action types.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-metrics-and-ai-enhancement/03-RESEARCH.md
@src/Orbit.Domain/Enums/AiActionType.cs
@src/Orbit.Domain/Models/AiAction.cs
@src/Orbit.Domain/Models/AiActionPlan.cs
@src/Orbit.Domain/Interfaces/IAiIntentService.cs
@src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
@src/Orbit.Infrastructure/Services/GeminiIntentService.cs
@src/Orbit.Infrastructure/Services/AiIntentService.cs
@src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
@src/Orbit.Domain/Entities/Habit.cs
@src/Orbit.Domain/Entities/Tag.cs
@src/Orbit.Domain/Entities/SubHabit.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AI domain models and update SystemPromptBuilder with sub-habit/tag/refusal patterns</name>
  <files>
    src/Orbit.Domain/Enums/AiActionType.cs
    src/Orbit.Domain/Models/AiAction.cs
    src/Orbit.Domain/Interfaces/IAiIntentService.cs
    src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
  </files>
  <action>
    **1. Update `src/Orbit.Domain/Enums/AiActionType.cs`:**
    Add two new values: `CreateSubHabit` and `AssignTag`. Keep existing `LogHabit` and `CreateHabit`.

    **2. Update `src/Orbit.Domain/Models/AiAction.cs`:**
    Add three optional properties to the existing record:
    - `public List<string>? SubHabits { get; init; }` -- sub-habit titles for CreateHabit (inline creation) or CreateSubHabit (add to existing habit)
    - `public List<string>? TagNames { get; init; }` -- suggested tag names (informational, included in aiMessage)
    - `public List<Guid>? TagIds { get; init; }` -- existing tag IDs for AssignTag action

    **3. Update `src/Orbit.Domain/Interfaces/IAiIntentService.cs`:**
    Add a `tags` parameter to `InterpretAsync`: `Task<Result<AiActionPlan>> InterpretAsync(string userMessage, IReadOnlyList<Habit> activeHabits, IReadOnlyList<Tag> userTags, CancellationToken cancellationToken = default)`.
    This requires adding `using Orbit.Domain.Entities;` if not already present. The AI needs to know existing tags to suggest assignment (by ID) vs creation of new tags.

    **4. Update `src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs`:**
    Change signature to: `public static string BuildSystemPrompt(IReadOnlyList<Habit> activeHabits, IReadOnlyList<Tag> userTags)`

    Add to the "What You CAN Do" section (after existing items):
    ```
    - Create habits with sub-habits/checklists (e.g., "morning routine with meditate, journal, stretch")
    - Suggest relevant tags when creating habits
    - Assign existing tags to habits when user requests
    ```

    Add a new "## User's Tags" section AFTER the "User's Active Habits" section:
    - If no tags: display "(none - user hasn't created tags yet)"
    - If tags exist, list each as: `- "{tag.Name}" | ID: {tag.Id} | Color: {tag.Color}`
    - After listing: "When user wants to tag a habit with an EXISTING tag -> use AssignTag with the exact ID above"
    - "When user mentions a NEW tag that doesn't exist -> include tagNames in aiMessage as suggestions (user creates tags manually)"

    Add new action type examples in the "Response JSON Schema & Examples" section:

    **Sub-habit creation with CreateHabit (inline):**
    ```
    User: "Create morning routine with meditate, journal, and stretch"
    {
      "actions": [
        {
          "type": "CreateHabit",
          "title": "Morning Routine",
          "habitType": "Boolean",
          "frequencyUnit": "Day",
          "frequencyQuantity": 1,
          "subHabits": ["Meditate", "Journal", "Stretch"]
        }
      ],
      "aiMessage": "Created your morning routine with 3 sub-habits: Meditate, Journal, and Stretch!"
    }
    ```

    **Sub-habit addition to existing habit (CreateSubHabit):**
    ```
    User: "Add 'cool down' and 'warm up' to my gym habit" (Gym habit EXISTS with ID "xxx")
    {
      "actions": [
        {
          "type": "CreateSubHabit",
          "habitId": "xxx-guid-here",
          "subHabits": ["Warm Up", "Cool Down"]
        }
      ],
      "aiMessage": "Added 2 sub-habits to your Gym habit: Warm Up and Cool Down!"
    }
    ```

    **Tag assignment (AssignTag):**
    ```
    User: "Add the wellness tag to my meditation habit" (Meditation habit ID: "abc...", wellness tag ID: "def...")
    {
      "actions": [
        {
          "type": "AssignTag",
          "habitId": "abc-123-guid",
          "tagIds": ["def-456-guid"]
        }
      ],
      "aiMessage": "Added 'wellness' tag to your meditation habit!"
    }
    ```

    **Tag suggestion (informational only, no action):**
    ```
    User: "I want to start doing yoga every morning"
    {
      "actions": [
        {
          "type": "CreateHabit",
          "title": "Yoga",
          "habitType": "Boolean",
          "frequencyUnit": "Day",
          "frequencyQuantity": 1
        }
      ],
      "aiMessage": "Created your daily yoga habit! You might want to add tags like 'morning', 'wellness', or 'fitness' to organize it."
    }
    ```

    Update the "Action Types & Required Fields" section to include:
    ```
    CreateSubHabit: type, habitId, subHabits (array of titles)
    AssignTag: type, habitId, tagIds (array of existing tag IDs from the list above)
    ```

    IMPORTANT: The existing refusal patterns in the prompt are already good (AI-01 is partially satisfied). Verify the existing "What You CANNOT Do" and "When Users Ask Out-of-Scope Questions" sections are intact. Do NOT remove or weaken existing refusal instructions. The key improvement for AI-01 is ensuring the _ => default case in the handler (Task 2) does not crash on truly unknown types.
  </action>
  <verify>
    `dotnet build src/Orbit.Infrastructure/Orbit.Infrastructure.csproj` compiles with zero errors.
  </verify>
  <done>
    AiActionType has CreateSubHabit and AssignTag. AiAction record has SubHabits, TagNames, TagIds fields. IAiIntentService accepts tags. SystemPromptBuilder generates prompt with sub-habit examples, tag listing, tag assignment examples, and preserved refusal patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AI services and ProcessUserChatCommand to handle new action types</name>
  <files>
    src/Orbit.Infrastructure/Services/GeminiIntentService.cs
    src/Orbit.Infrastructure/Services/AiIntentService.cs
    src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
  </files>
  <action>
    **1. Update `src/Orbit.Infrastructure/Services/GeminiIntentService.cs`:**
    Update `InterpretAsync` signature to match new interface: add `IReadOnlyList<Tag> userTags` parameter.
    Update the `SystemPromptBuilder.BuildSystemPrompt` call to pass `userTags`: `SystemPromptBuilder.BuildSystemPrompt(activeHabits, userTags)`.
    Add `using Orbit.Domain.Entities;` if not present.

    **2. Update `src/Orbit.Infrastructure/Services/AiIntentService.cs` (OllamaIntentService):**
    Same changes as GeminiIntentService -- update `InterpretAsync` signature and `BuildSystemPrompt` call.

    **3. Update `src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs`:**

    a) Add `IGenericRepository<Tag>` injection to `ProcessUserChatCommandHandler` constructor alongside existing repositories.

    b) After fetching active habits (step 1 in existing code), add a query to fetch user's tags:
    ```csharp
    var userTags = await tagRepository.FindAsync(
        t => t.UserId == request.UserId,
        cancellationToken);
    ```
    Log the count similarly to habits.

    c) Update the `aiIntentService.InterpretAsync` call to pass `userTags`:
    ```csharp
    var planResult = await aiIntentService.InterpretAsync(
        request.Message,
        activeHabits,
        userTags,
        cancellationToken);
    ```

    d) Add two new cases to the action type switch expression:
    ```csharp
    AiActionType.CreateSubHabit => await ExecuteCreateSubHabitAsync(action, request.UserId, cancellationToken),
    AiActionType.AssignTag => await ExecuteAssignTagAsync(action, request.UserId, cancellationToken),
    ```

    e) Update `ExecuteCreateHabitAsync` to handle inline sub-habits: after `habitRepository.AddAsync(habitResult.Value, ct)`, check if `action.SubHabits` has items. If so, iterate and call `habitResult.Value.AddSubHabit(title, sortOrder)` for each, incrementing sortOrder from 0.

    f) Implement `ExecuteCreateSubHabitAsync`:
    ```csharp
    private async Task<Result> ExecuteCreateSubHabitAsync(AiAction action, Guid userId, CancellationToken ct)
    {
        if (action.HabitId is null || action.SubHabits is null || action.SubHabits.Count == 0)
            return Result.Failure("HabitId and SubHabits are required for CreateSubHabit.");

        var habit = await habitRepository.FindOneTrackedAsync(
            h => h.Id == action.HabitId && h.UserId == userId,
            q => q.Include(h => h.SubHabits),
            ct);

        if (habit is null)
            return Result.Failure("Habit not found.");

        int sortOrder = habit.SubHabits.Count;
        foreach (var title in action.SubHabits)
        {
            var result = habit.AddSubHabit(title, sortOrder++);
            if (result.IsFailure)
                return Result.Failure(result.Error);
        }

        return Result.Success();
    }
    ```

    g) Implement `ExecuteAssignTagAsync`:
    ```csharp
    private async Task<Result> ExecuteAssignTagAsync(AiAction action, Guid userId, CancellationToken ct)
    {
        if (action.HabitId is null || action.TagIds is null || action.TagIds.Count == 0)
            return Result.Failure("HabitId and TagIds are required for AssignTag.");

        var habit = await habitRepository.FindOneTrackedAsync(
            h => h.Id == action.HabitId && h.UserId == userId,
            q => q.Include(h => h.Tags),
            ct);

        if (habit is null)
            return Result.Failure("Habit not found.");

        foreach (var tagId in action.TagIds)
        {
            var tag = await tagRepository.GetByIdAsync(tagId, ct);
            if (tag is null || tag.UserId != userId)
                continue; // Skip invalid/unauthorized tags silently

            if (!habit.Tags.Any(t => t.Id == tagId))
                habit.Tags.Add(tag);
        }

        return Result.Success();
    }
    ```

    h) Add `using Microsoft.EntityFrameworkCore;` at the top if not already present (for `Include` in the new methods).

    NOTE: `tagRepository` requires injecting `IGenericRepository<Tag>`. Since Tag extends Entity (has an Id property), it works with GenericRepository. The Tag entity is registered in OrbitDbContext as `DbSet<Tag> Tags`.
  </action>
  <verify>
    `dotnet build src/Orbit.Api/Orbit.Api.csproj` compiles with zero errors (verifies full dependency chain).
  </verify>
  <done>
    Both GeminiIntentService and OllamaIntentService pass user tags to SystemPromptBuilder. ProcessUserChatCommand fetches user tags, passes them to AI service, and handles CreateSubHabit and AssignTag actions. CreateHabit also supports inline SubHabits array. AI graceful refusal is ensured by existing prompt patterns plus the _ => default handler case.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` -- entire solution compiles with zero errors
2. AiActionType enum has 4 values: LogHabit, CreateHabit, CreateSubHabit, AssignTag
3. SystemPromptBuilder.BuildSystemPrompt accepts both habits and tags parameters
4. POST /api/chat correctly handles messages requesting sub-habit creation and tag assignment
5. POST /api/chat returns helpful refusal message for out-of-scope requests (existing behavior preserved)
</verification>

<success_criteria>
- AiActionType extended with CreateSubHabit and AssignTag
- AiAction record has SubHabits, TagNames, TagIds optional fields
- IAiIntentService.InterpretAsync accepts userTags parameter
- Both Gemini and Ollama services pass tags to SystemPromptBuilder
- SystemPromptBuilder includes user's tags section and sub-habit/tag action examples
- ProcessUserChatCommand handles CreateSubHabit and AssignTag actions
- CreateHabit handler supports inline SubHabits array
- Existing refusal patterns preserved (AI-01)
- Solution builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-metrics-and-ai-enhancement/03-02-SUMMARY.md`
</output>
