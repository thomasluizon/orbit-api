---
phase: 07-routine-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
  - src/Orbit.Infrastructure/Services/GeminiIntentService.cs
  - src/Orbit.Infrastructure/Services/AiIntentService.cs
  - src/Orbit.Domain/Interfaces/IAiIntentService.cs
  - tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "When user creates a habit via chat, the response includes a conflict warning if scheduling conflicts with detected routine patterns"
    - "AI system prompt includes routine patterns when available, improving scheduling advice"
    - "Routine analysis is non-critical — failures are logged as warnings and don't block chat responses"
    - "Integration tests verify routine pattern detection, conflict warnings, and time slot suggestions via chat"
  artifacts:
    - path: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      provides: "Chat handler with routine analysis integration and conflict warnings in CreateHabit flow"
      contains: "IRoutineAnalysisService"
    - path: "tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs"
      provides: "Integration tests for routine intelligence features"
      contains: "Routine"
  key_links:
    - from: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      to: "src/Orbit.Domain/Interfaces/IRoutineAnalysisService.cs"
      via: "constructor injection"
      pattern: "IRoutineAnalysisService"
    - from: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      to: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      via: "passes routine patterns to BuildSystemPrompt"
      pattern: "routinePatterns"
    - from: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      to: "ChatResponse"
      via: "ConflictWarning field on ActionResult"
      pattern: "ConflictWarning"
---

<objective>
Integrate routine analysis into the chat pipeline: feed routine patterns into AI system prompt, add conflict warnings to habit creation responses, and add integration tests covering all routine intelligence features.

Purpose: Connect the routine analysis service (from Plan 01) to the user-facing chat flow so users see scheduling conflict warnings when creating habits, and the AI has routine context for better scheduling advice. Verify all RTNI requirements via integration tests.

Output: Modified chat handler, updated AI intent service signature, integration tests for routine intelligence.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-routine-intelligence/07-RESEARCH.md
@.planning/phases/07-routine-intelligence/07-01-SUMMARY.md
@src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
@src/Orbit.Infrastructure/Services/GeminiIntentService.cs
@src/Orbit.Infrastructure/Services/AiIntentService.cs
@src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
@src/Orbit.Domain/Interfaces/IAiIntentService.cs
@src/Orbit.Domain/Models/RoutineAnalysis.cs
@tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate routine analysis into chat pipeline and add conflict warnings</name>
  <files>
    src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
    src/Orbit.Infrastructure/Services/GeminiIntentService.cs
    src/Orbit.Infrastructure/Services/AiIntentService.cs
    src/Orbit.Domain/Interfaces/IAiIntentService.cs
  </files>
  <action>
    **Modify `ProcessUserChatCommand.cs`:**

    1. Add `IRoutineAnalysisService routineAnalysisService` to the primary constructor parameters.

    2. After loading user facts (step 1c) and before calling AI intent service (step 2), add routine analysis (step 1d):
       ```csharp
       // 1d. Analyze user's routine patterns for AI context (non-critical)
       IReadOnlyList<RoutinePattern> routinePatterns = [];
       try
       {
           var routineResult = await routineAnalysisService.AnalyzeRoutinesAsync(request.UserId, cancellationToken);
           if (routineResult.IsSuccess)
               routinePatterns = routineResult.Value.Patterns;
       }
       catch (Exception ex)
       {
           logger.LogWarning(ex, "Routine analysis failed - non-critical, continuing without patterns");
       }
       ```

    3. Update the `InterpretAsync` call to pass `routinePatterns` as a new parameter.

    4. Add `ConflictWarning? ConflictWarning` field to the `ActionResult` record (after `SuggestedSubHabits`).

    5. In `ExecuteCreateHabitAsync`, add conflict detection AFTER successful habit creation:
       - Inject `IRoutineAnalysisService` into the method via the class-level field
       - After `habitRepository.AddAsync(habit, ct)`, call:
         ```csharp
         ConflictWarning? conflictWarning = null;
         if (action.FrequencyUnit.HasValue)
         {
             try
             {
                 var conflictResult = await routineAnalysisService.DetectConflictsAsync(
                     userId, action.FrequencyUnit, action.FrequencyQuantity, action.Days, ct);
                 if (conflictResult.IsSuccess)
                     conflictWarning = conflictResult.Value;
             }
             catch (Exception ex)
             {
                 logger.LogWarning(ex, "Conflict detection failed - non-critical");
             }
         }
         ```
       - Return the ConflictWarning in the ActionResult for CreateHabit actions:
         Update the success ActionResult creation in the main loop to pass ConflictWarning when action type is CreateHabit.
         In the foreach loop where actionResults are built, when action.Type == AiActionType.CreateHabit, the ActionResult should include the ConflictWarning.
         To accomplish this, change `ExecuteCreateHabitAsync` return type to include ConflictWarning:
         Return `Result<(Guid? Id, string? Name, ConflictWarning? Conflict)>` — and update the caller accordingly.
         All other Execute methods keep returning `(Guid? Id, string? Name)` — handle this by making the main loop check action type for CreateHabit specifically.

         SIMPLER APPROACH: Store conflict warnings in a dictionary `Dictionary<int, ConflictWarning?>` keyed by action index. After ExecuteCreateHabitAsync succeeds, store the conflict warning. When building ActionResult, include it. This avoids changing return types of all Execute methods.

    **Modify `IAiIntentService.cs`:**
    Add `IReadOnlyList<RoutinePattern>? routinePatterns = null` parameter to `InterpretAsync` (after `imageMimeType`, before `cancellationToken`).
    Add `using Orbit.Domain.Models;` import.

    **Modify `GeminiIntentService.cs`:**
    1. Update `InterpretAsync` signature to accept `IReadOnlyList<RoutinePattern>? routinePatterns = null`
    2. Pass `routinePatterns` to `SystemPromptBuilder.BuildSystemPrompt(..., routinePatterns: routinePatterns)`

    **Modify `AiIntentService.cs` (Ollama):**
    1. Update `InterpretAsync` signature to accept `IReadOnlyList<RoutinePattern>? routinePatterns = null`
    2. Pass `routinePatterns` to `SystemPromptBuilder.BuildSystemPrompt(..., routinePatterns: routinePatterns)`

    IMPORTANT: Routine analysis is NON-CRITICAL — wrap in try/catch, log warnings, continue without. Same pattern as fact extraction. This ensures the chat endpoint never fails due to routine analysis errors.

    IMPORTANT: Conflict detection happens AFTER habit creation (warnings, not blockers). The habit is always created. ConflictWarning is informational only.
  </action>
  <verify>
    Run `dotnet build Orbit.slnx` to confirm all projects compile. Verify ProcessUserChatCommand has IRoutineAnalysisService dependency. Verify ActionResult has ConflictWarning field. Verify IAiIntentService, GeminiIntentService, and OllamaIntentService all have routinePatterns parameter.
  </verify>
  <done>
    Chat pipeline loads routine patterns and passes them to AI intent service for context-aware responses. CreateHabit actions include conflict detection with warnings. ActionResult includes optional ConflictWarning. All routine analysis is non-critical (try/catch with warning logs). Full solution builds cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for routine intelligence</name>
  <files>
    tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
  </files>
  <action>
    Add integration tests to the EXISTING `AiChatIntegrationTests.cs` file. Follow the existing test patterns in that file (multipart form-data, JWT auth, sequential test collection).

    Add these tests:

    1. **`Chat_AskAboutRoutinePatterns_ShouldAnalyzeAndRespond`**
       - Send a chat message like "analyze my routine" or "when do I usually exercise?"
       - Verify response has aiMessage containing scheduling/routine analysis content
       - This tests that routine context is available to the AI (RTNI-01)

    2. **`Chat_CreateHabitWithPotentialConflict_ShouldReturnWarning`**
       - First create a daily habit via chat (e.g., "I want to exercise every weekday morning")
       - Then create another habit on the same schedule (e.g., "I want to meditate every weekday morning")
       - Verify the response includes the created habit (habit creation succeeds — not blocked)
       - Note: ConflictWarning may or may not be populated depending on whether enough log history exists. The test verifies the happy path — creation succeeds regardless of conflict detection. (RTNI-02)

    3. **`Chat_AskForScheduleSuggestions_ShouldReturnTimeSlots`**
       - Send: "when should I schedule a new reading habit?"
       - Verify response has aiMessage with scheduling suggestions
       - The AI should leverage routine context to suggest times (RTNI-03)

    4. **`Chat_RoutineAnalysisWithNoData_ShouldNotFail`**
       - Register a fresh user with no habits/logs
       - Send: "analyze my routine"
       - Verify response is successful (200 OK) with a message like "not enough data" or empty routine info
       - This tests the minimum data threshold gracefully (RTNI-04 edge case)

    Follow existing test patterns:
    - Use `MultipartFormDataContent` for sending chat messages (Phase 6 change)
    - Use the helper methods already in the test class for registration/login/auth
    - Each test should be independent (register new user per test)
    - Use `[Fact]` attribute, add descriptive names
    - Keep assertions focused: check status code is 200, check response structure, check aiMessage is not empty
    - Do NOT assert on exact AI-generated text (non-deterministic) — assert on structure and non-null/non-empty fields

    IMPORTANT: These are integration tests hitting real Gemini API. Keep them focused and minimal to avoid rate limiting. Use `Task.Delay(1000)` between API calls if needed (existing pattern in test file).
  </action>
  <verify>
    Run `dotnet test tests/Orbit.IntegrationTests/ --filter "Routine"` to execute only the new routine tests. All should pass. Then run `dotnet test tests/Orbit.IntegrationTests/` to verify no existing tests were broken.
  </verify>
  <done>
    4 new integration tests verify routine intelligence: pattern analysis via chat, conflict warning on habit creation, time slot suggestions, and graceful handling of insufficient data. All new tests pass. All existing tests continue to pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Orbit.slnx` compiles with no errors
2. `dotnet test tests/Orbit.IntegrationTests/` — all tests pass (existing + 4 new)
3. Chat pipeline injects IRoutineAnalysisService and passes patterns to AI
4. CreateHabit actions include ConflictWarning in response
5. ActionResult record has ConflictWarning? field
6. Routine analysis failures don't break chat responses (non-critical wrapping)
7. IAiIntentService, GeminiIntentService, OllamaIntentService all accept routinePatterns parameter
</verification>

<success_criteria>
- ProcessUserChatCommand integrates routine analysis (non-critical, try/catch)
- AI intent service receives routine patterns for system prompt context
- CreateHabit actions return optional ConflictWarning
- 4 new integration tests pass: routine analysis, conflict detection, time slot suggestions, no-data edge case
- All 16+ existing tests continue to pass
- Routine intelligence is fully integrated into the chat flow
</success_criteria>

<output>
After completion, create `.planning/phases/07-routine-intelligence/07-02-SUMMARY.md`
</output>
