---
phase: 01-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Orbit.Api/Orbit.Api.csproj
  - src/Orbit.Infrastructure/Orbit.Infrastructure.csproj
  - src/Orbit.Api/Program.cs
  - src/Orbit.Api/OpenApi/BearerSecuritySchemeTransformer.cs
  - src/Orbit.Infrastructure/Services/JwtTokenService.cs
  - src/Orbit.Infrastructure/Persistence/Migrations/ (generated)
autonomous: true

must_haves:
  truths:
    - "Database schema changes are managed through EF Core migrations (EnsureCreated is gone)"
    - "API documentation is browsable via Scalar UI at /scalar/v1"
    - "JWT authentication works with the updated Microsoft.IdentityModel.JsonWebTokens library"
  artifacts:
    - path: "src/Orbit.Infrastructure/Persistence/Migrations/*_BaselineMigration.cs"
      provides: "Empty baseline migration (Up/Down bodies empty)"
      contains: "protected override void Up"
    - path: "src/Orbit.Infrastructure/Persistence/Migrations/OrbitDbContextModelSnapshot.cs"
      provides: "EF Core model snapshot reflecting current schema"
      contains: "OrbitDbContextModelSnapshot"
    - path: "src/Orbit.Api/OpenApi/BearerSecuritySchemeTransformer.cs"
      provides: "JWT auth in OpenAPI documents"
      contains: "IOpenApiDocumentTransformer"
    - path: "src/Orbit.Infrastructure/Services/JwtTokenService.cs"
      provides: "JWT token generation via JsonWebTokenHandler"
      contains: "JsonWebTokenHandler"
    - path: "src/Orbit.Api/Program.cs"
      provides: "Updated startup with MigrateAsync, OpenApi, Scalar"
      contains: "MigrateAsync"
  key_links:
    - from: "src/Orbit.Api/Program.cs"
      to: "EF Core Migrations"
      via: "db.Database.MigrateAsync()"
      pattern: "MigrateAsync"
    - from: "src/Orbit.Api/Program.cs"
      to: "src/Orbit.Api/OpenApi/BearerSecuritySchemeTransformer.cs"
      via: "AddDocumentTransformer"
      pattern: "AddDocumentTransformer<BearerSecuritySchemeTransformer>"
    - from: "src/Orbit.Api/Program.cs"
      to: "Scalar UI"
      via: "MapScalarApiReference"
      pattern: "MapScalarApiReference"
    - from: "src/Orbit.Infrastructure/Services/JwtTokenService.cs"
      to: "Microsoft.IdentityModel.JsonWebTokens"
      via: "using + CreateToken"
      pattern: "JsonWebTokenHandler"
---

<objective>
Replace deprecated infrastructure with current ecosystem standards: EF Core migrations (replacing EnsureCreated), Microsoft.AspNetCore.OpenApi + Scalar (replacing Swashbuckle), and Microsoft.IdentityModel.JsonWebTokens (replacing System.IdentityModel.Tokens.Jwt).

Purpose: Establishes the migration foundation that all future schema changes depend on, modernizes API documentation, and upgrades JWT handling -- three independent library swaps unified by their shared touchpoint in Program.cs.

Output: Working application with migration-based schema management, Scalar API explorer at /scalar/v1, and modern JWT token generation.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md

Key source files:
@src/Orbit.Api/Program.cs
@src/Orbit.Api/Orbit.Api.csproj
@src/Orbit.Infrastructure/Orbit.Infrastructure.csproj
@src/Orbit.Infrastructure/Services/JwtTokenService.cs
@src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: EF Core baseline migration + JWT upgrade + package changes</name>
  <files>
    src/Orbit.Infrastructure/Orbit.Infrastructure.csproj
    src/Orbit.Api/Orbit.Api.csproj
    src/Orbit.Infrastructure/Services/JwtTokenService.cs
    src/Orbit.Infrastructure/Persistence/Migrations/ (generated by dotnet ef)
  </files>
  <action>
    **Step 1: Package changes**

    In `src/Orbit.Infrastructure/Orbit.Infrastructure.csproj`:
    - Remove `System.IdentityModel.Tokens.Jwt` (version 8.3.2)
    - Add `Microsoft.IdentityModel.JsonWebTokens` version 8.15.0

    In `src/Orbit.Api/Orbit.Api.csproj`:
    - Remove `Swashbuckle.AspNetCore` (version 7.2.0)
    - Add `Microsoft.AspNetCore.OpenApi` version 10.0.2
    - Add `Scalar.AspNetCore` version 2.12.36

    Run these via `dotnet` CLI commands:
    ```
    dotnet remove src/Orbit.Infrastructure/Orbit.Infrastructure.csproj package System.IdentityModel.Tokens.Jwt
    dotnet add src/Orbit.Infrastructure/Orbit.Infrastructure.csproj package Microsoft.IdentityModel.JsonWebTokens --version 8.15.0
    dotnet remove src/Orbit.Api/Orbit.Api.csproj package Swashbuckle.AspNetCore
    dotnet add src/Orbit.Api/Orbit.Api.csproj package Microsoft.AspNetCore.OpenApi --version 10.0.2
    dotnet add src/Orbit.Api/Orbit.Api.csproj package Scalar.AspNetCore --version 2.12.36
    ```

    Ensure `dotnet-ef` tool is installed: `dotnet tool update --global dotnet-ef`

    **Step 2: Update JwtTokenService.cs**

    Replace the current implementation that uses `JwtSecurityToken` + `JwtSecurityTokenHandler` with `JsonWebTokenHandler` + `SecurityTokenDescriptor`:

    - Change `using System.IdentityModel.Tokens.Jwt;` to `using Microsoft.IdentityModel.JsonWebTokens;`
    - Replace the method body to use `SecurityTokenDescriptor` with `Subject = new ClaimsIdentity(...)` containing the same 3 claims (NameIdentifier, Email, Jti)
    - Use `new JsonWebTokenHandler().CreateToken(descriptor)` which returns a `string` directly (no WriteToken needed)
    - Keep all existing claim types and values identical
    - Keep `SecurityAlgorithms.HmacSha256` for signing
    - Keep `_settings.Issuer`, `_settings.Audience`, `_settings.ExpiryHours` usage
    - If a deprecation warning appears for `Subject`, switch to the `Claims` dictionary approach on `SecurityTokenDescriptor`

    See research RESEARCH.md "Pattern 4" for the exact code pattern.

    **Step 3: Generate baseline migration**

    Run from solution root:
    ```
    dotnet ef migrations add BaselineMigration --project src/Orbit.Infrastructure --startup-project src/Orbit.Api
    ```

    This generates a migration with `CreateTable` calls. Open the generated `*_BaselineMigration.cs` file and EMPTY the `Up(MigrationBuilder migrationBuilder)` and `Down(MigrationBuilder migrationBuilder)` method bodies completely -- leave them as `{ }`. Do NOT touch the `.Designer.cs` file or the `OrbitDbContextModelSnapshot.cs` file.

    Then apply: `dotnet ef database update --project src/Orbit.Infrastructure --startup-project src/Orbit.Api`

    This creates the `__EFMigrationsHistory` table and records the baseline without running any SQL against existing tables.

    IMPORTANT: The database must be running (PostgreSQL) for this step. If the connection fails, the migration can still be generated but `database update` will need to run when the DB is available.
  </action>
  <verify>
    1. `dotnet build Orbit.slnx` succeeds with no errors
    2. Migration file exists at `src/Orbit.Infrastructure/Persistence/Migrations/*_BaselineMigration.cs` with empty Up()/Down() bodies
    3. `OrbitDbContextModelSnapshot.cs` exists and contains model definitions
    4. `JwtTokenService.cs` uses `JsonWebTokenHandler` (not `JwtSecurityTokenHandler`)
    5. No references to `System.IdentityModel.Tokens.Jwt` remain in any .csproj
    6. No references to `Swashbuckle` remain in any .csproj
  </verify>
  <done>
    Packages swapped (Swashbuckle removed, OpenApi+Scalar added; legacy JWT removed, JsonWebTokens added). JwtTokenService uses JsonWebTokenHandler. Baseline migration generated with empty Up/Down and model snapshot intact. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: OpenAPI/Scalar setup in Program.cs + BearerSecuritySchemeTransformer</name>
  <files>
    src/Orbit.Api/OpenApi/BearerSecuritySchemeTransformer.cs
    src/Orbit.Api/Program.cs
  </files>
  <action>
    **Step 1: Create BearerSecuritySchemeTransformer**

    Create `src/Orbit.Api/OpenApi/BearerSecuritySchemeTransformer.cs` implementing `IOpenApiDocumentTransformer`. This replaces Swashbuckle's `AddSecurityDefinition` + `AddSecurityRequirement` approach.

    The transformer should:
    - Inject `IAuthenticationSchemeProvider` via primary constructor
    - In `TransformAsync`, check if a "Bearer" authentication scheme exists
    - If it does, add a `SecurityScheme` entry to `document.Components.SecuritySchemes` with:
      - Type = `SecuritySchemeType.Http`
      - Scheme = `"bearer"`
      - In = `ParameterLocation.Header`
      - BearerFormat = `"Json Web Token"`
    - Add an `OpenApiSecurityRequirement` to each operation referencing the Bearer scheme
    - Namespace: `Orbit.Api.OpenApi`
    - Class should be `internal sealed`

    See research RESEARCH.md "Pattern 3" for the exact code. IMPORTANT: .NET 10 uses OpenAPI.NET 2.x which may have breaking changes around `OpenApiSecurityScheme.Reference`. If the code from research doesn't compile, check the `Microsoft.OpenApi.Models` API surface. The `Reference` property may need to be set as `new OpenApiReference { Id = "Bearer", Type = ReferenceType.SecurityScheme }` or the scheme may need to be added differently. Try the research pattern first; if it doesn't compile, iterate to find the correct .NET 10 OpenAPI.NET 2.x syntax.

    **Step 2: Update Program.cs**

    Replace the entire Swagger/Swashbuckle section with OpenAPI + Scalar:

    1. Remove `using Microsoft.OpenApi.Models;` if it was only for Swashbuckle (check if BearerSecuritySchemeTransformer needs it -- if so, keep it in that file only)
    2. Remove the `builder.Services.AddEndpointsApiExplorer();` line
    3. Remove the entire `builder.Services.AddSwaggerGen(options => { ... });` block (lines 92-130 currently)
    4. Add in its place:
       ```csharp
       builder.Services.AddOpenApi(options =>
       {
           options.AddDocumentTransformer<BearerSecuritySchemeTransformer>();
       });
       ```
       Add the `using Orbit.Api.OpenApi;` import at the top.

    5. Replace the pipeline section:
       Remove:
       ```csharp
       app.UseSwagger();
       app.UseSwaggerUI(options =>
       {
           options.SwaggerEndpoint("/swagger/v1/swagger.json", "Orbit API v1");
           options.RoutePrefix = string.Empty;
       });
       ```
       Replace with:
       ```csharp
       app.MapOpenApi();
       app.MapScalarApiReference();
       ```
       Keep these inside the `if (app.Environment.IsDevelopment())` block. Add `using Scalar.AspNetCore;` at the top for `MapScalarApiReference()`.

    6. Replace the database initialization section:
       Change `await db.Database.EnsureCreatedAsync();` to `await db.Database.MigrateAsync();`

    7. Ensure `using Microsoft.EntityFrameworkCore;` is present (needed for `MigrateAsync` extension method -- it should already be there for `UseNpgsql`).
  </action>
  <verify>
    1. `dotnet build Orbit.slnx` succeeds with no errors
    2. No references to `UseSwagger`, `UseSwaggerUI`, `AddSwaggerGen`, `AddEndpointsApiExplorer`, or `EnsureCreatedAsync` in Program.cs
    3. Program.cs contains `AddOpenApi`, `MapOpenApi`, `MapScalarApiReference`, `MigrateAsync`
    4. `BearerSecuritySchemeTransformer.cs` exists and implements `IOpenApiDocumentTransformer`
    5. Run `dotnet run --project src/Orbit.Api` briefly and verify the app starts without errors (Ctrl+C to stop). If DB is unavailable, a connection error is acceptable -- the key check is that OpenAPI/Scalar configuration doesn't throw at startup.
  </verify>
  <done>
    Program.cs uses MigrateAsync instead of EnsureCreated. Swashbuckle replaced by Microsoft.AspNetCore.OpenApi + Scalar.AspNetCore. BearerSecuritySchemeTransformer provides JWT auth in OpenAPI docs. Application builds and starts successfully. Scalar UI available at /scalar/v1 in development mode.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Orbit.slnx` -- clean build, no errors, no warnings from deprecated packages
2. No remaining references to: `Swashbuckle`, `System.IdentityModel.Tokens.Jwt`, `EnsureCreated`, `JwtSecurityToken`, `JwtSecurityTokenHandler`, `UseSwagger`, `UseSwaggerUI`
3. Migration infrastructure in place: `__EFMigrationsHistory` table exists (or will be created on first run), baseline migration recorded
4. Verify `dotnet run --project src/Orbit.Api` starts without configuration errors
5. If database is accessible: verify `/scalar/v1` loads the API explorer UI, verify `/openapi/v1.json` returns the OpenAPI spec with Bearer security scheme
</verification>

<success_criteria>
- EnsureCreated is replaced by MigrateAsync with a baseline migration
- Swashbuckle is replaced by Microsoft.AspNetCore.OpenApi + Scalar
- System.IdentityModel.Tokens.Jwt is replaced by Microsoft.IdentityModel.JsonWebTokens
- Application builds, starts, and serves API documentation at /scalar/v1
- JWT token generation produces valid tokens using the new library
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md`
</output>
