---
phase: 01-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Orbit.Domain/Entities/TaskItem.cs (DELETE)
  - src/Orbit.Domain/Enums/TaskItemStatus.cs (DELETE)
  - src/Orbit.Domain/Enums/AiActionType.cs
  - src/Orbit.Domain/Models/AiAction.cs
  - src/Orbit.Domain/Interfaces/IAiIntentService.cs
  - src/Orbit.Application/Tasks/ (DELETE entire folder)
  - src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
  - src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
  - src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
  - src/Orbit.Infrastructure/Services/GeminiIntentService.cs
  - src/Orbit.Infrastructure/Services/AiIntentService.cs
  - src/Orbit.Api/Controllers/TasksController.cs (DELETE)
  - tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
  - src/Orbit.Infrastructure/Persistence/Migrations/ (generated RemoveTaskItems migration)
autonomous: true

must_haves:
  truths:
    - "All task management code is removed from the codebase"
    - "AI chat correctly handles only habit-related actions (CreateHabit, LogHabit)"
    - "AI correctly rejects task-like requests with a helpful redirect to habits"
    - "The Tasks database table is dropped via migration"
    - "Application builds and all remaining tests pass"
  artifacts:
    - path: "src/Orbit.Domain/Enums/AiActionType.cs"
      provides: "AiActionType enum with only LogHabit and CreateHabit"
      contains: "LogHabit"
    - path: "src/Orbit.Domain/Models/AiAction.cs"
      provides: "AiAction record without task-related properties"
    - path: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      provides: "Chat handler with only habit-related action execution"
    - path: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      provides: "AI prompt mentioning only habits, no task references"
    - path: "src/Orbit.Infrastructure/Persistence/Migrations/*_RemoveTaskItems.cs"
      provides: "Migration that drops the Tasks table"
      contains: "DropTable"
  key_links:
    - from: "src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs"
      to: "src/Orbit.Domain/Enums/AiActionType.cs"
      via: "switch expression on action.Type"
      pattern: "action\\.Type switch"
    - from: "src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs"
      to: "src/Orbit.Domain/Entities/Habit.cs"
      via: "BuildSystemPrompt parameter"
      pattern: "IReadOnlyList<Habit>"
    - from: "src/Orbit.Infrastructure/Services/GeminiIntentService.cs"
      to: "src/Orbit.Domain/Interfaces/IAiIntentService.cs"
      via: "implements IAiIntentService.InterpretAsync"
      pattern: "InterpretAsync"
---

<objective>
Remove all task management code from the codebase -- entities, commands, queries, controllers, AI pipeline references, and integration tests -- then generate a migration to drop the Tasks table.

Purpose: Orbit is a habit tracker, not a life management suite. Removing tasks simplifies the codebase, the AI prompt, and the domain model. This is the largest change in Phase 1, touching 15+ files across all layers.

Output: Clean codebase with no task references. AI only handles habit actions. RemoveTaskItems migration drops the Tasks table.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md
@.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md

Key source files (read ALL of these before modifying):
@src/Orbit.Domain/Entities/TaskItem.cs
@src/Orbit.Domain/Enums/TaskItemStatus.cs
@src/Orbit.Domain/Enums/AiActionType.cs
@src/Orbit.Domain/Models/AiAction.cs
@src/Orbit.Domain/Interfaces/IAiIntentService.cs
@src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
@src/Orbit.Application/Tasks/Commands/CreateTaskCommand.cs
@src/Orbit.Application/Tasks/Commands/UpdateTaskCommand.cs
@src/Orbit.Application/Tasks/Commands/DeleteTaskCommand.cs
@src/Orbit.Application/Tasks/Queries/GetTasksQuery.cs
@src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
@src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
@src/Orbit.Infrastructure/Services/GeminiIntentService.cs
@src/Orbit.Infrastructure/Services/AiIntentService.cs
@src/Orbit.Api/Controllers/TasksController.cs
@tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove task code from Domain + Application + Infrastructure + API layers</name>
  <files>
    src/Orbit.Domain/Entities/TaskItem.cs (DELETE)
    src/Orbit.Domain/Enums/TaskItemStatus.cs (DELETE)
    src/Orbit.Domain/Enums/AiActionType.cs
    src/Orbit.Domain/Models/AiAction.cs
    src/Orbit.Domain/Interfaces/IAiIntentService.cs
    src/Orbit.Application/Tasks/ (DELETE entire folder -- 4 files)
    src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs
    src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
    src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs
    src/Orbit.Infrastructure/Services/GeminiIntentService.cs
    src/Orbit.Infrastructure/Services/AiIntentService.cs
    src/Orbit.Api/Controllers/TasksController.cs (DELETE)
  </files>
  <action>
    Work layer by layer, bottom-up (Domain first, then Application, then Infrastructure, then API). Read each file before modifying to understand the full scope.

    **Domain Layer:**

    1. DELETE `src/Orbit.Domain/Entities/TaskItem.cs`
    2. DELETE `src/Orbit.Domain/Enums/TaskItemStatus.cs`
    3. MODIFY `src/Orbit.Domain/Enums/AiActionType.cs` -- Remove `CreateTask` and `UpdateTask` enum values. Keep only `LogHabit` and `CreateHabit`.
    4. MODIFY `src/Orbit.Domain/Models/AiAction.cs` -- Remove these properties: `DueDate` (DateOnly?), `TaskId` (Guid?), `NewStatus` (TaskItemStatus?). Remove the `using Orbit.Domain.Enums;` import for `TaskItemStatus` if it was only used for `NewStatus` (but keep it if `AiActionType` needs it -- check). Keep all habit-related properties (HabitId, Title, Description, Value, FrequencyUnit, FrequencyQuantity, HabitType, Unit, Days).
    5. MODIFY `src/Orbit.Domain/Interfaces/IAiIntentService.cs` -- Remove the `IReadOnlyList<TaskItem> pendingTasks` parameter from `InterpretAsync`. Remove the `using Orbit.Domain.Entities;` import if `TaskItem` was the only entity referenced (but `Habit` is also referenced, so keep `Entities` import). The signature becomes: `Task<Result<AiActionPlan>> InterpretAsync(string userMessage, IReadOnlyList<Habit> activeHabits, CancellationToken cancellationToken = default);`

    **Application Layer:**

    6. DELETE the entire `src/Orbit.Application/Tasks/` folder (includes `Commands/CreateTaskCommand.cs`, `Commands/UpdateTaskCommand.cs`, `Commands/DeleteTaskCommand.cs`, `Queries/GetTasksQuery.cs`)
    7. MODIFY `src/Orbit.Application/Chat/Commands/ProcessUserChatCommand.cs`:
       - Remove `IGenericRepository<TaskItem> taskRepository` from constructor injection
       - Remove `using Orbit.Domain.Entities;` only if `TaskItem` was the only entity (but `Habit` is used -- keep the import but remove `TaskItem` usage)
       - Remove the pending tasks query block: the `var pendingTasks = await taskRepository.FindAsync(...)` call and the `TaskItemStatus` references
       - Update the `aiIntentService.InterpretAsync` call to remove the `pendingTasks` argument
       - Update the logging line that mentions "Tasks: {TaskCount}" -- remove the task count reference
       - Remove the `AiActionType.CreateTask` and `AiActionType.UpdateTask` cases from the switch expression
       - DELETE the `ExecuteCreateTaskAsync` method entirely
       - DELETE the `ExecuteUpdateTaskAsync` method entirely
       - Keep `ExecuteLogHabitAsync` and `ExecuteCreateHabitAsync` unchanged
       - Remove `using Orbit.Domain.Enums;` ONLY if `TaskItemStatus` was its only usage (but `AiActionType` needs it -- keep the import)

    **Infrastructure Layer:**

    8. MODIFY `src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs`:
       - Remove `public DbSet<TaskItem> Tasks => Set<TaskItem>();`
       - Remove the entire `modelBuilder.Entity<TaskItem>(entity => { ... });` block from `OnModelCreating`
       - Remove `using Orbit.Domain.Entities;` ONLY if TaskItem was the only entity (but User, Habit, HabitLog are still used -- keep the import but ensure TaskItem is not referenced)

    9. MODIFY `src/Orbit.Infrastructure/Services/SystemPromptBuilder.cs`:
       - Remove `IReadOnlyList<TaskItem> pendingTasks` parameter from `BuildSystemPrompt`
       - Remove the `using Orbit.Domain.Entities;` import ONLY if TaskItem was its only usage (Habit is also referenced -- keep it but remove TaskItem usage)
       - In the prompt text, remove ALL task references:
         - In "Your Core Identity & Boundaries": Remove "Tasks (managing to-do items and one-time actions)" from the list
         - In "What You CAN Do": Remove "Create tasks with due dates" and "Mark tasks as completed, cancelled, or in progress"
         - Update scope description: Change "I can only help you track habits and manage tasks" to "I can only help you track and manage habits"
         - Remove rule 9: "For one-time actions with dates (today, tomorrow, etc.), use CreateTask"
         - In "User's Pending Tasks" section: Remove the entire section (the heading, the loop, and the conditional)
         - In examples: Remove the "I need to buy eggs today" CreateTask example, the "I finished watering plants" UpdateTask example
         - Remove from "Action Types & Required Fields": Remove `CreateTask: type, title, dueDate (optional), description (optional)` and `UpdateTask: type, taskId, newStatus (Completed | Cancelled | InProgress)`
         - Update out-of-scope examples to include a "I need to buy eggs" style message being redirected to habits (e.g., "That sounds like a one-time action. I only handle recurring habits. Would you like to create a habit instead?")
         - Update the title/identity to "Orbit AI - A Personal Habit Tracking Assistant" (remove "& Task Management")
       - IMPORTANT: Keep all habit-related examples and rules intact. Only remove task-specific content.

    10. MODIFY `src/Orbit.Infrastructure/Services/GeminiIntentService.cs`:
        - Update `InterpretAsync` signature to match new `IAiIntentService` (remove `IReadOnlyList<TaskItem> pendingTasks` parameter)
        - Update `SystemPromptBuilder.BuildSystemPrompt(activeHabits, pendingTasks)` call to `SystemPromptBuilder.BuildSystemPrompt(activeHabits)`
        - Remove `using Orbit.Domain.Entities;` ONLY if TaskItem was its only usage (Habit is also referenced)

    11. MODIFY `src/Orbit.Infrastructure/Services/AiIntentService.cs` (this is OllamaIntentService.cs -- the file is named differently but contains `OllamaIntentService`):
        - Same changes as GeminiIntentService: remove pendingTasks parameter, update BuildSystemPrompt call
        - Remove TaskItem-related imports if unused

    **API Layer:**

    12. DELETE `src/Orbit.Api/Controllers/TasksController.cs`

    **Build check:** After all modifications, run `dotnet build Orbit.slnx` and fix any remaining compilation errors. Common issues:
    - Orphaned `using` statements referencing deleted types
    - Any file referencing `TaskItem`, `TaskItemStatus`, `CreateTask`, `UpdateTask` that was missed
    - Use `grep -r "TaskItem\|TaskItemStatus\|CreateTask\|UpdateTask\|pendingTasks\|taskRepository" src/` to find any remaining references
  </action>
  <verify>
    1. `dotnet build Orbit.slnx` succeeds with zero errors
    2. No files exist: `TaskItem.cs`, `TaskItemStatus.cs`, `TasksController.cs`, any file in `Tasks/` folder
    3. Grep for "TaskItem" across `src/` returns zero results
    4. Grep for "CreateTask" across `src/` returns zero results (except possibly in git history)
    5. Grep for "UpdateTask" across `src/` returns zero results
    6. Grep for "pendingTasks" across `src/` returns zero results
    7. `AiActionType.cs` contains only `LogHabit` and `CreateHabit`
    8. `AiAction.cs` has no `TaskId`, `NewStatus`, or `DueDate` properties
    9. `IAiIntentService.InterpretAsync` takes only `(string, IReadOnlyList<Habit>, CancellationToken)`
  </verify>
  <done>
    All task management code removed from all 4 layers. Domain entities, enums, application commands/queries, infrastructure services, API controller, and AI pipeline cleaned of task references. Build succeeds with zero task-related code remaining.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update integration tests + generate RemoveTaskItems migration</name>
  <files>
    tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs
    src/Orbit.Infrastructure/Persistence/Migrations/ (generated RemoveTaskItems migration)
  </files>
  <action>
    **Step 1: Update integration tests**

    Modify `tests/Orbit.IntegrationTests/AiChatIntegrationTests.cs`:

    1. In `DisposeAsync()`: Remove the entire "Delete all tasks" block (lines fetching tasks and deleting them via `/api/tasks`). Remove the `TaskDto` record from the DTOs region. Keep the "Delete all habits" cleanup block and the user deletion.

    2. Remove the `#region Task Creation Tests (3)` block entirely -- all 3 tests:
       - `Chat_CreateTask_WithToday_ShouldSucceed` -- DELETE
       - `Chat_CreateTask_WithTomorrow_ShouldSucceed` -- DELETE
       - `Chat_CreateMultipleTasks_ShouldSucceed` -- DELETE

    3. Remove the `#region Task Completion Tests (1)` block entirely:
       - `Chat_CompleteTask_ShouldSucceed` -- DELETE

    4. Update `Chat_MixedActionsInOneMessage_ShouldHandleAll` test:
       - Change the message from `"i need to buy milk, i want to start meditating daily, and i ran 5km"` to `"i want to start meditating daily and i ran 5km"` (remove task-like request)
       - The assertion `HaveCountGreaterThan(1)` stays the same (expects CreateHabit + CreateHabit or CreateHabit + LogHabit)

    5. Optionally ADD a new test to verify task-like requests are rejected gracefully:
       ```csharp
       [Fact]
       public async Task Chat_TaskLikeRequest_ShouldRedirectToHabits()
       {
           // Act
           var response = await SendChatMessage("i need to buy milk today");

           // Assert - Should not create any actions (no CreateTask exists)
           response.ExecutedActions.Should().BeEmpty();
           response.AiMessage.Should().NotBeNullOrEmpty();
       }
       ```
       Add this in the `#region Out-of-Scope Tests` region or create a new region.

    6. Update the test class summary comment to reflect the new test count (was 15, now approximately 11 core scenarios after removing 4 task tests and adding 1 redirect test).

    **Step 2: Generate RemoveTaskItems migration**

    After Task 1 removed `DbSet<TaskItem> Tasks` and its model configuration from `OrbitDbContext`, EF Core will detect the model change. Generate the migration:

    ```
    dotnet ef migrations add RemoveTaskItems --project src/Orbit.Infrastructure --startup-project src/Orbit.Api
    ```

    This should generate a migration with `DropTable("Tasks")` in the `Up()` method and `CreateTable("Tasks", ...)` in the `Down()` method. Do NOT modify this migration -- it should correctly drop the Tasks table. Review it to confirm it only drops the Tasks table and its index, nothing else.

    Apply the migration (if database is accessible):
    ```
    dotnet ef database update --project src/Orbit.Infrastructure --startup-project src/Orbit.Api
    ```

    If the database is not accessible, the migration files are still generated and will apply on next `MigrateAsync()` at startup.
  </action>
  <verify>
    1. `dotnet build Orbit.slnx` succeeds (including test project)
    2. No task-related test methods remain in `AiChatIntegrationTests.cs`
    3. Grep for "CreateTask\|UpdateTask\|TaskDto\|api/tasks" in test files returns zero results
    4. RemoveTaskItems migration exists at `src/Orbit.Infrastructure/Persistence/Migrations/*_RemoveTaskItems.cs`
    5. The RemoveTaskItems migration `Up()` contains `DropTable` for the Tasks table
    6. The RemoveTaskItems migration `Down()` contains `CreateTable` for the Tasks table (rollback)
    7. `dotnet test` on the test project compiles (tests may not pass without running API + DB, but compilation must succeed)
  </verify>
  <done>
    Integration tests updated: 4 task-related tests removed, 1 task-redirect test added. Test cleanup no longer references task endpoints. RemoveTaskItems migration generated to drop the Tasks table. Full solution builds including test project.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Orbit.slnx` -- clean build, zero errors
2. Comprehensive grep across entire `src/` and `tests/` for task remnants:
   - `grep -r "TaskItem" src/ tests/` returns zero results
   - `grep -r "TaskItemStatus" src/ tests/` returns zero results
   - `grep -r "CreateTask" src/ tests/` returns zero results
   - `grep -r "UpdateTask" src/ tests/` returns zero results
   - `grep -r "TasksController" src/ tests/` returns zero results
   - `grep -r "pendingTasks" src/ tests/` returns zero results
   - `grep -r "taskRepository" src/ tests/` returns zero results
3. Two migrations exist: BaselineMigration (from Plan 01) and RemoveTaskItems
4. `AiActionType` enum has exactly 2 values: `LogHabit`, `CreateHabit`
5. SystemPromptBuilder mentions only habits, not tasks
6. AI prompt examples show no CreateTask or UpdateTask actions
</verification>

<success_criteria>
- Zero task-related code in the codebase (entities, enums, commands, queries, controllers, tests, AI pipeline)
- RemoveTaskItems migration generated and ready to apply
- AI prompt updated to be habits-only, with task-like requests redirected gracefully
- Integration tests compile and reflect habits-only functionality
- Application builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-03-SUMMARY.md`
</output>
