---
phase: 02-habit-domain-extensions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Orbit.Domain/Entities/Habit.cs
  - src/Orbit.Domain/Entities/HabitLog.cs
  - src/Orbit.Domain/Entities/SubHabit.cs
  - src/Orbit.Domain/Entities/SubHabitLog.cs
  - src/Orbit.Domain/Entities/Tag.cs
  - src/Orbit.Domain/Entities/HabitTag.cs
  - src/Orbit.Domain/Entities/User.cs
  - src/Orbit.Domain/Interfaces/IGenericRepository.cs
  - src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
  - src/Orbit.Infrastructure/Persistence/GenericRepository.cs
autonomous: true

must_haves:
  truths:
    - "Habit entity supports IsNegative flag, SubHabits navigation, and Tags navigation"
    - "HabitLog entity supports optional Note field"
    - "SubHabit and SubHabitLog entities exist with correct factory methods and relationships"
    - "Tag and HabitTag entities exist with composite key on HabitTag"
    - "User entity supports TimeZone property with validation"
    - "GenericRepository supports Include-based queries via new FindAsync overload"
    - "EF Core migration applies cleanly and creates all new tables/columns"
  artifacts:
    - path: "src/Orbit.Domain/Entities/SubHabit.cs"
      provides: "SubHabit entity with HabitId FK, Title, SortOrder, IsActive"
    - path: "src/Orbit.Domain/Entities/SubHabitLog.cs"
      provides: "SubHabitLog entity with SubHabitId FK, Date, IsCompleted"
    - path: "src/Orbit.Domain/Entities/Tag.cs"
      provides: "Tag entity with UserId, Name, Color (hex), factory Create method"
    - path: "src/Orbit.Domain/Entities/HabitTag.cs"
      provides: "Join entity with HabitId + TagId composite key, no Entity base"
    - path: "src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs"
      provides: "DbSets for SubHabit, SubHabitLog, Tag; OnModelCreating with FK configs, cascade delete, indexes"
      contains: "UsingEntity<HabitTag>"
  key_links:
    - from: "src/Orbit.Domain/Entities/Habit.cs"
      to: "src/Orbit.Domain/Entities/SubHabit.cs"
      via: "IReadOnlyCollection<SubHabit> SubHabits navigation property"
      pattern: "SubHabits"
    - from: "src/Orbit.Domain/Entities/Habit.cs"
      to: "src/Orbit.Domain/Entities/Tag.cs"
      via: "ICollection<Tag> Tags navigation property"
      pattern: "Tags"
    - from: "src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs"
      to: "src/Orbit.Domain/Entities/HabitTag.cs"
      via: "UsingEntity<HabitTag> many-to-many config"
      pattern: "UsingEntity<HabitTag>"
    - from: "src/Orbit.Domain/Interfaces/IGenericRepository.cs"
      to: "src/Orbit.Infrastructure/Persistence/GenericRepository.cs"
      via: "FindAsync overload with includes parameter"
      pattern: "Func<IQueryable<T>, IQueryable<T>>"
---

<objective>
Create all new domain entities (SubHabit, SubHabitLog, Tag, HabitTag), extend existing entities (Habit, HabitLog, User), configure EF Core relationships, add repository includes support, and generate the database migration.

Purpose: Establishes the complete domain model foundation that Plans 02 and 03 build upon. No commands/queries/controllers yet -- just entities, DbContext, repository, and migration.
Output: 6 entity files (4 new, 2 modified), updated User, updated DbContext with full relationship config, updated GenericRepository with includes, one EF Core migration.
</objective>

<execution_context>
@C:\Users\thoma\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\thoma\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-habit-domain-extensions/02-RESEARCH.md
@src/Orbit.Domain/Entities/Habit.cs
@src/Orbit.Domain/Entities/HabitLog.cs
@src/Orbit.Domain/Entities/User.cs
@src/Orbit.Domain/Common/Entity.cs
@src/Orbit.Domain/Common/Result.cs
@src/Orbit.Domain/Interfaces/IGenericRepository.cs
@src/Orbit.Infrastructure/Persistence/GenericRepository.cs
@src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new domain entities and extend existing ones</name>
  <files>
    src/Orbit.Domain/Entities/SubHabit.cs
    src/Orbit.Domain/Entities/SubHabitLog.cs
    src/Orbit.Domain/Entities/Tag.cs
    src/Orbit.Domain/Entities/HabitTag.cs
    src/Orbit.Domain/Entities/Habit.cs
    src/Orbit.Domain/Entities/HabitLog.cs
    src/Orbit.Domain/Entities/User.cs
  </files>
  <action>
    **New: SubHabit.cs** -- extends Entity. Properties: `Guid HabitId` (FK), `string Title`, `int SortOrder`, `bool IsActive = true`, `DateTime CreatedAtUtc`. Private constructor. Factory method `Create(Guid habitId, string title, int sortOrder)` returning `Result<SubHabit>` -- validates habitId not empty, title not blank. Include `Deactivate()` method.

    **New: SubHabitLog.cs** -- extends Entity. Properties: `Guid SubHabitId` (FK), `DateOnly Date`, `bool IsCompleted`, `DateTime CreatedAtUtc`. Private constructor. Factory method `Create(Guid subHabitId, DateOnly date, bool isCompleted)` -- no Result wrapper needed, this is simple like HabitLog (use internal static, return SubHabitLog directly).

    **New: Tag.cs** -- extends Entity. Properties: `Guid UserId` (FK), `string Name`, `string Color` (hex like "#FF5733"), `DateTime CreatedAtUtc`. Navigation: `ICollection<Habit> Habits { get; private set; } = []` for skip navigation. Private constructor. Factory method `Create(Guid userId, string name, string color)` returning `Result<Tag>` -- validates userId not empty, name not blank, color is valid 7-char hex (#XXXXXX). Color stored as uppercase. Include private static `IsValidHexColor(string)` helper.

    **New: HabitTag.cs** -- plain class, does NOT extend Entity (no Id property). Properties: `Guid HabitId { get; private set; }`, `Guid TagId { get; private set; }`. No factory method needed. Include a constructor `HabitTag(Guid habitId, Guid tagId)` and private parameterless constructor for EF.

    **Modify: Habit.cs** -- Add properties:
    - `bool IsNegative { get; private set; }` (default false)
    - Navigation: `private readonly List<SubHabit> _subHabits = []` with `public IReadOnlyCollection<SubHabit> SubHabits => _subHabits.AsReadOnly()`
    - Navigation: `public ICollection<Tag> Tags { get; private set; } = []` (for EF skip navigation)
    - Update `Create()` factory: add `bool isNegative = false` parameter, set `IsNegative = isNegative`
    - Update `Log()` method: add `string? note = null` parameter, pass it to `HabitLog.Create()`. Change duplicate check to only block for non-negative boolean habits: `if (Type == HabitType.Boolean && !IsNegative && _logs.Exists(l => l.Date == date))`. This allows negative habits to log multiple slip-ups per day.
    - Add method `AddSubHabit(string title, int sortOrder)` returning `Result<SubHabit>` -- calls SubHabit.Create, adds to _subHabits, returns the created sub-habit.
    - Add method `RemoveSubHabit(Guid subHabitId)` returning `Result` -- finds sub-habit, deactivates it.

    **Modify: HabitLog.cs** -- Add property: `string? Note { get; private set; }`. Update `Create()` method signature to accept `string? note = null` parameter and set it.

    **Modify: User.cs** -- Add property: `string? TimeZone { get; private set; }`. Add method `SetTimeZone(string ianaTimeZoneId)` returning `Result` -- validates via `TimeZoneInfo.FindSystemTimeZoneById()`, catches `TimeZoneNotFoundException` to return failure. Also add `ClearTimeZone()` method that sets TimeZone to null (for resetting to UTC default).
  </action>
  <verify>
    Run `dotnet build src/Orbit.Domain/Orbit.Domain.csproj` -- must compile with zero errors.
    Verify: SubHabit.cs, SubHabitLog.cs, Tag.cs, HabitTag.cs all exist in src/Orbit.Domain/Entities/.
    Verify: Habit.cs has IsNegative, SubHabits, Tags properties.
    Verify: HabitLog.cs has Note property.
    Verify: User.cs has TimeZone property and SetTimeZone method.
  </verify>
  <done>
    All 7 entity files compile. SubHabit, SubHabitLog, Tag, HabitTag are new entities following existing conventions. Habit has IsNegative + SubHabits + Tags. HabitLog has Note. User has TimeZone. Negative boolean habits allow multiple logs per day.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure DbContext, update repository, and generate migration</name>
  <files>
    src/Orbit.Infrastructure/Persistence/OrbitDbContext.cs
    src/Orbit.Domain/Interfaces/IGenericRepository.cs
    src/Orbit.Infrastructure/Persistence/GenericRepository.cs
  </files>
  <action>
    **Modify: OrbitDbContext.cs** -- Add DbSets:
    - `DbSet<SubHabit> SubHabits => Set<SubHabit>()`
    - `DbSet<SubHabitLog> SubHabitLogs => Set<SubHabitLog>()`
    - `DbSet<Tag> Tags => Set<Tag>()`

    In `OnModelCreating`, add configurations:

    SubHabit:
    - `HasOne<Habit>().WithMany(h => h.SubHabits).HasForeignKey(sh => sh.HabitId).OnDelete(DeleteBehavior.Cascade)` -- note: WithMany must reference the backing field; use the public navigation property. EF Core should pick up the private `_subHabits` field via the public `SubHabits` property. If not, configure with `.HasField("_subHabits")`.
    - Index on `{ HabitId, SortOrder }`

    SubHabitLog:
    - `HasOne<SubHabit>().WithMany().HasForeignKey(sl => sl.SubHabitId).OnDelete(DeleteBehavior.Cascade)`
    - Index on `{ SubHabitId, Date }`

    Tag:
    - Unique index on `{ UserId, Name }`

    Habit-Tag many-to-many:
    ```
    modelBuilder.Entity<Habit>()
        .HasMany(h => h.Tags)
        .WithMany(t => t.Habits)
        .UsingEntity<HabitTag>(
            r => r.HasOne<Tag>().WithMany().HasForeignKey(ht => ht.TagId).OnDelete(DeleteBehavior.Cascade),
            l => l.HasOne<Habit>().WithMany().HasForeignKey(ht => ht.HabitId).OnDelete(DeleteBehavior.Cascade),
            j => j.HasKey(ht => new { ht.HabitId, ht.TagId }));
    ```

    IMPORTANT: The Habit -> SubHabits relationship must configure the private backing field. Since `SubHabits` is `IReadOnlyCollection<SubHabit>` backed by `_subHabits`, use EF navigation property access mode. Specifically, configure with:
    ```
    modelBuilder.Entity<Habit>()
        .HasMany(typeof(SubHabit), "_subHabits")
        .WithOne()
        .HasForeignKey(nameof(SubHabit.HabitId))
        .OnDelete(DeleteBehavior.Cascade);
    ```
    OR access the property directly if EF can resolve it via the public `SubHabits` property. Try the simpler approach first (referencing h => h.SubHabits), and if EF complains about the read-only collection, fall back to the string-based field name approach. The Logs relationship already works with the same `_logs` / `Logs` pattern -- check how the existing `Habit.Logs` mapping works (it uses `.HasMany(h => h.Logs)` which works because `Logs` is `IReadOnlyCollection` and EF auto-discovers the `_logs` backing field).

    **Modify: IGenericRepository.cs** -- Add a second `FindAsync` overload:
    ```csharp
    Task<IReadOnlyList<T>> FindAsync(
        Expression<Func<T, bool>> predicate,
        Func<IQueryable<T>, IQueryable<T>>? includes,
        CancellationToken cancellationToken = default);
    ```

    **Modify: GenericRepository.cs** -- Implement the new overload:
    ```csharp
    public async Task<IReadOnlyList<T>> FindAsync(
        Expression<Func<T, bool>> predicate,
        Func<IQueryable<T>, IQueryable<T>>? includes,
        CancellationToken cancellationToken = default)
    {
        IQueryable<T> query = _dbSet.AsNoTracking();
        if (includes is not null)
            query = includes(query);
        return await query.Where(predicate).ToListAsync(cancellationToken);
    }
    ```

    **Generate migration:** After all code compiles, run:
    ```
    dotnet ef migrations add AddHabitDomainExtensions --project src/Orbit.Infrastructure --startup-project src/Orbit.Api
    ```
    This creates one migration covering: SubHabits table, SubHabitLogs table, Tags table, HabitTags table, Habit.IsNegative column, HabitLog.Note column, User.TimeZone column.

    After generating, verify the migration Up method contains the expected CREATE TABLE and ALTER TABLE statements. Do NOT apply the migration yet (it will be applied automatically by MigrateAsync on next app startup).
  </action>
  <verify>
    Run `dotnet build` from solution root -- must compile with zero errors.
    Verify migration file exists in `src/Orbit.Infrastructure/Migrations/` with name containing `AddHabitDomainExtensions`.
    Run `dotnet ef migrations list --project src/Orbit.Infrastructure --startup-project src/Orbit.Api` -- should show the new migration as pending.
  </verify>
  <done>
    DbContext has 3 new DbSets with full relationship configuration (cascade deletes, indexes, composite key on HabitTag). GenericRepository has FindAsync overload supporting Include chains. Migration file exists and is valid. Solution builds with zero errors.
  </done>
</task>

</tasks>

<verification>
- `dotnet build Orbit.slnx` compiles with zero errors
- All 4 new entity files exist in src/Orbit.Domain/Entities/
- Habit.cs has IsNegative, SubHabits (IReadOnlyCollection), Tags (ICollection) properties
- HabitLog.cs has Note property
- User.cs has TimeZone property and SetTimeZone method
- OrbitDbContext has SubHabits, SubHabitLogs, Tags DbSets
- IGenericRepository has two FindAsync overloads
- Migration file exists with correct schema changes
</verification>

<success_criteria>
- Solution compiles cleanly (zero errors)
- 4 new entity files created (SubHabit, SubHabitLog, Tag, HabitTag)
- 3 existing entity files updated (Habit, HabitLog, User)
- DbContext fully configured with cascade deletes and indexes
- Repository supports Include-based queries
- Migration generated and pending
</success_criteria>

<output>
After completion, create `.planning/phases/02-habit-domain-extensions/02-01-SUMMARY.md`
</output>
